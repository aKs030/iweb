#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const repoRoot = path.resolve(__dirname, '..');
const outFile = path.join(repoRoot, 'IMPORTANT_REPORT.md');

function walk(dir, fileList = []) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const e of entries) {
    if (e.name === '.git' || e.name === 'node_modules' || e.name === 'test-results') continue;
    const full = path.join(dir, e.name);
    if (e.isDirectory()) walk(full, fileList);
    else if (/\.css$/.test(e.name)) fileList.push(full);
  }
  return fileList;
}

function classify(line, file) {
  // Heuristic: some !important are likely safe candidates (test-resets, animation zeroing)
  const lower = line.toLowerCase();
  if (/animation-duration:\s*0(?:\.0+)?ms|animation-iteration-count: 1|transition-duration:\s*0(?:\.0+)?ms|transition-delay:\s*0ms/.test(lower)) return 'candidate-test-reset';
  if (/visually-hidden|clip:\s*rect\(0 0 0 0\)/.test(lower)) return 'skip-accessibility';
  if (/display:\s*none/.test(lower)) return 'review';
  // default: needs human review
  return 'review';
}

function main() {
  const files = walk(repoRoot);
  const report = [];
  for (const f of files) {
    const txt = fs.readFileSync(f, 'utf8');
    const lines = txt.split(/\r?\n/);
    for (let i=0;i<lines.length;i++) {
      if (lines[i].includes('!important')) {
        const context = lines.slice(Math.max(0,i-2), Math.min(lines.length,i+3)).join('\n');
        const cls = classify(lines[i], f);
        report.push({file: path.relative(repoRoot,f), line: i+1, snippet: lines[i].trim(), context, classification: cls});
      }
    }
  }

  const grouped = report.reduce((acc,e)=>{ (acc[e.classification] = acc[e.classification]||[]).push(e); return acc; }, {});
  let md = '# IMPORTANT_SCAN Report\n\n';
  md += 'Generated by `tools/scan-important.js` — this file lists all occurrences of `!important` in CSS files and classifies candidates for removal or review.\n\n';
  md += '## Summary\n\n';
  md += `Total occurrences: ${report.length}\n\n`;
  for (const k of Object.keys(grouped)) md += `- ${k}: ${grouped[k].length}\n`;
  md += '\n---\n\n';

  for (const k of ['candidate-test-reset','skip-accessibility','review']) {
    if (!grouped[k]) continue;
    md += `## ${k}\n\n`;
    for (const item of grouped[k]) {
      md += `- **${item.file}:${item.line}** — ${item.snippet}\n\n`;
      md += '```\n' + item.context + '\n```\n\n';
    }
  }

  fs.writeFileSync(outFile, md, 'utf8');
  console.log('Report written to', outFile);
}

main();
