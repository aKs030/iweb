name: Weekly Code Quality Report

on:
  schedule:
    # Jeden Montag um 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Manuell auslÃ¶sbar

jobs:
  quality-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Knip
        run: |
          echo "# ðŸ” Knip Report" > quality-report.md
          echo "" >> quality-report.md
          npx knip --reporter markdown >> quality-report.md || true
          echo "" >> quality-report.md
      
      - name: Check duplicates
        run: |
          echo "# ðŸ“‹ Duplicate Code Report" >> quality-report.md
          echo "" >> quality-report.md
          npx jscpd content/ pages/ workers/ --min-lines 10 --min-tokens 50 --format javascript --reporters markdown >> quality-report.md || true
          echo "" >> quality-report.md
        continue-on-error: true
      
      - name: Analyze complexity
        run: |
          echo "# ðŸ“Š Complexity Report" >> quality-report.md
          echo "" >> quality-report.md
          npx es6-plato -r -d complexity-report content/ pages/ workers/ || true
          echo "Report generated in complexity-report/" >> quality-report.md
          echo "" >> quality-report.md
        continue-on-error: true
      
      - name: Check circular dependencies
        run: |
          echo "# ðŸ”„ Circular Dependencies" >> quality-report.md
          echo "" >> quality-report.md
          npx madge --circular --extensions js content/ pages/ workers/ >> quality-report.md || echo "âœ… No circular dependencies found" >> quality-report.md
          echo "" >> quality-report.md
      
      - name: Bundle size analysis
        run: |
          echo "# ðŸ“¦ Bundle Size" >> quality-report.md
          echo "" >> quality-report.md
          npm run build
          echo "\`\`\`" >> quality-report.md
          du -sh dist/ >> quality-report.md
          du -sh dist/assets/*.js 2>/dev/null >> quality-report.md || true
          du -sh dist/assets/*.css 2>/dev/null >> quality-report.md || true
          echo "\`\`\`" >> quality-report.md
          echo "" >> quality-report.md
      
      - name: Security audit
        run: |
          echo "# ðŸ”’ Security Audit" >> quality-report.md
          echo "" >> quality-report.md
          echo "\`\`\`" >> quality-report.md
          npm audit || true >> quality-report.md
          echo "\`\`\`" >> quality-report.md
          echo "" >> quality-report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            quality-report.md
            complexity-report/
          retention-days: 2
      
      - name: Create Issue with Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly Code Quality Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['quality', 'automated']
            });
