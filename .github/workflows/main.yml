name: CI/CD
on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' }}

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-deps
      - run: npm run check

  actionlint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/actionlint@v1.7.11

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
      - uses: github/codeql-action/analyze@v4

  preview:
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-deps
      - id: secrets
        run: echo "has=${{ secrets.CLOUDFLARE_API_TOKEN != '' }}" >> "$GITHUB_OUTPUT"
      - if: steps.secrets.outputs.has == 'true'
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name=1web --commit-dirty=true
      - uses: actions/github-script@v7
        env:
          HAS: ${{ steps.secrets.outputs.has }}
          URL: ${{ steps.deploy.outputs.deployment-url }}
        with:
          script: |
            const m = '<!-- preview -->';
            const has = process.env.HAS === 'true';
            const url = process.env.URL;
            const body = has ? `${m}\n## ðŸš€ Preview\n\n[${url}](${url})` : `${m}\n## âš ï¸ Skipped\n\nAdd: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID`;
            const { data: c } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const e = c.find(x => x.user.type === 'Bot' && x.body.includes(m));
            const fn = e ? github.rest.issues.updateComment : github.rest.issues.createComment;
            await fn({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ...(e ? { comment_id: e.id } : { issue_number: context.issue.number }),
              body,
            });
