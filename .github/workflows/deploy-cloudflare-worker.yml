name: Deploy Cloudflare Worker (sitemap headers)

on:
  push:
    branches: [ main ]

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload Worker Script
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          WORKER_NAME: sitemap-headers
        run: |
          echo "Uploading worker script..."
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/workers/scripts/$WORKER_NAME" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/javascript" \
            --data-binary @cloudflare/workers/sitemap-headers/index.js | jq .

      - name: Ensure routes exist for sitemaps
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          WORKER_NAME: sitemap-headers
          DOMAIN: abdulkerimsesli.de
        run: |
          set -e
          for pattern in "/sitemap.xml" "/sitemap-videos.xml"; do
            full_pattern="$DOMAIN$pattern"
            echo "Ensuring route: $full_pattern"
            # check existing route id
            ROUTE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/workers/routes" \
              -H "Authorization: Bearer $CF_API_TOKEN" | jq -r --arg p "$full_pattern" '.result // [] | .[] | select(.pattern==$p) | .id')
            if [ -n "$ROUTE_ID" ]; then
              echo "Updating route $ROUTE_ID"
              curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/workers/routes/$ROUTE_ID" \
                -H "Authorization: Bearer $CF_API_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{ \"pattern\": \"$full_pattern\", \"script\": \"$WORKER_NAME\" }" | jq .
            else
              echo "Creating route for $full_pattern"
              curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/workers/routes" \
                -H "Authorization: Bearer $CF_API_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{ \"pattern\": \"$full_pattern\", \"script\": \"$WORKER_NAME\" }" | jq .
            fi
          done

      - name: Verify headers are applied
        env:
          DOMAIN: https://abdulkerimsesli.de
        run: |
          echo "Checking sitemap headers..."
          for path in "/sitemap.xml" "/sitemap-videos.xml"; do
            echo "Checking $path"
            curl -s -I "$DOMAIN$path" | sed -n '1,50p'
          done

      - name: Done
        run: echo "Worker deploy + route check completed"