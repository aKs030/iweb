let v,c,d;try{({createLogger:v,CookieManager:c}=await import("../../utils/shared-utilities.js").catch(()=>{throw new Error("Utils missing")})),{a11y:d}=await import("../../utils/accessibility-manager.js").catch(()=>{throw new Error("A11y missing")})}catch{v=()=>({info:console.warn,warn:console.warn,error:console.error}),c={get:n=>localStorage.getItem(n),set:(n,t)=>localStorage.setItem(n,t),deleteAnalytics:()=>console.warn("Analytics deleted (Mock)")},d={announce:n=>console.warn(`[A11y]: ${n}`),trapFocus:()=>{},releaseFocus:()=>{}}}const g=v("FooterSystem"),S=(n,t)=>{let e;return(...o)=>{clearTimeout(e),e=setTimeout(()=>n(...o),t)}},C=n=>{const t=new Map;return(...e)=>{const o=JSON.stringify(e);if(t.has(o))return t.get(o);const s=n(...e);return t.set(o,s),s}},f={SCROLL_MARK_DURATION:1e3,SCROLL_WATCH_TIMEOUT:5e3,SCROLL_THRESHOLD:6,RESIZE_DEBOUNCE:150,ANIMATION_DURATION:800,EXPAND_LOCK_MS:1e3,COLLAPSE_DEBOUNCE_MS:250};class M{constructor(){this.cache=new Map}get(t,e=document){const o=`${t}-${e===document?"doc":"parent"}`;return this.cache.has(o)||this.cache.set(o,e.querySelector(t)),this.cache.get(o)}getAll(t,e=document){const o=`all-${t}`;return this.cache.has(o)||this.cache.set(o,Array.from(e.querySelectorAll(t))),this.cache.get(o)}invalidate(t){if(t){this.cache.delete(t);for(const e of this.cache.keys())e.startsWith(t)&&this.cache.delete(e)}else this.cache.clear()}}const r=new M,m=(()=>{let n=null,t=null;const e=new Map;return{create(o=f.SCROLL_MARK_DURATION){t&&clearTimeout(t);const s=Symbol("progScroll");return n=s,o>0&&(t=setTimeout(()=>{n===s&&(n=null),t=null},o)),s},clear(o){if(!(!n||o&&n!==o)&&(n=null,t&&clearTimeout(t),t=null,e.has(o))){const s=e.get(o);s.observer?.disconnect(),s.listener&&globalThis.removeEventListener("scroll",s.listener),s.timeoutId&&clearTimeout(s.timeoutId),e.delete(o)}},hasActive:()=>!!n,watchUntil(o,s,a=f.SCROLL_WATCH_TIMEOUT){if(!o)return;const i=typeof s=="string"?r.get(s):s;if(i&&"IntersectionObserver"in globalThis){const l=new IntersectionObserver(L=>{const w=L[0];w.isIntersecting&&w.intersectionRatio>=.5&&m.clear(o)},{threshold:[.5,1]});l.observe(i);const T=setTimeout(()=>{m.clear(o),l.disconnect()},a);return e.set(o,{observer:l,timeoutId:T}),o}const h=()=>{const l=globalThis.scrollY||globalThis.pageYOffset;(globalThis.innerHeight||0)+l>=document.body.scrollHeight-f.SCROLL_THRESHOLD&&m.clear(o)},p=()=>h();h(),globalThis.addEventListener("scroll",p,{passive:!0});const u=setTimeout(()=>m.clear(o),a);return e.set(o,{listener:p,timeoutId:u}),o}}})(),b=(()=>{let n=null,t=!1;const e=s=>{r.get("#site-footer")?.classList.contains("footer-expanded")&&(s.target.closest("#site-footer")||n?.())},o=()=>{m.hasActive()||!r.get("#site-footer")?.classList.contains("footer-expanded")||n?.()};return{setCloseHandler:s=>n=s,bind(){t||(globalThis.matchMedia?.("(max-width: 768px)")?.matches?(globalThis.addEventListener("scroll",o,{passive:!0}),globalThis.addEventListener("touchmove",o,{passive:!0})):(document.addEventListener("click",e,{capture:!0,passive:!0}),globalThis.addEventListener("wheel",o,{passive:!0}),globalThis.addEventListener("touchstart",o,{passive:!0})),t=!0)},unbind(){t&&(document.removeEventListener("click",e,!0),globalThis.removeEventListener("wheel",o),globalThis.removeEventListener("touchstart",o),globalThis.removeEventListener("scroll",o),globalThis.removeEventListener("touchmove",o),t=!1)}}})(),y={load(){performance.mark("analytics-load-start");const n=document.querySelectorAll('script[data-consent="required"]');n.length!==0&&(n.forEach(t=>{const e=document.createElement("script");Array.from(t.attributes).forEach(o=>{o.name==="data-src"?e.setAttribute("src",o.value):["data-consent","type"].includes(o.name)||e.setAttribute(o.name,o.value)}),t.innerHTML.trim()&&(e.innerHTML=t.innerHTML),t.parentNode.replaceChild(e,t)}),performance.mark("analytics-load-end"),performance.measure("analytics-load","analytics-load-start","analytics-load-end"),g.info("Google Analytics loaded"))}};class _{constructor(){this.elements={banner:r.get("#cookie-consent-banner"),acceptBtn:r.get("#accept-cookies-btn"),rejectBtn:r.get("#reject-cookies-btn")}}init(){const{banner:t,acceptBtn:e,rejectBtn:o}=this.elements;if(!t||!e)return;const s=c.get("cookie_consent");s==="accepted"?(y.load(),t.classList.add("hidden")):s==="rejected"?t.classList.add("hidden"):t.classList.remove("hidden"),e.addEventListener("click",()=>this.accept(),{once:!1}),o?.addEventListener("click",()=>this.reject(),{once:!1})}accept(){this.elements.banner.classList.add("hidden"),c.set("cookie_consent","accepted"),globalThis.dataLayer=globalThis.dataLayer||[],globalThis.dataLayer.push({event:"consentGranted"}),y.load();try{d?.announce("Cookie-Pr\xE4ferenz: Alle Cookies akzeptiert",{priority:"polite"})}catch{}}reject(){this.elements.banner.classList.add("hidden"),c.set("cookie_consent","rejected");try{d?.announce("Cookie-Pr\xE4ferenz: Nur notwendige Cookies akzeptiert",{priority:"polite"})}catch{}}}const A=(()=>{let n=null;const t=new Map,e=C(()=>({footer:r.get("#site-footer"),footerMin:r.get(".footer-minimized"),footerMax:r.get(".footer-maximized"),cookieView:r.get("#footer-cookie-view"),normalContent:r.get("#footer-normal-content"),analyticsToggle:r.get("#footer-analytics-toggle"),closeBtn:r.get("#close-cookie-footer"),rejectAllBtn:r.get("#footer-reject-all"),acceptSelectedBtn:r.get("#footer-accept-selected"),acceptAllBtn:r.get("#footer-accept-all"),triggerBtn:r.get("#footer-cookies-link")})),o=i=>{Object.entries({closeBtn:()=>a(),rejectAllBtn:()=>{c.set("cookie_consent","rejected"),c.deleteAnalytics();try{d?.announce("Cookie-Einstellungen: Nur notwendige Cookies aktiv",{priority:"polite"})}catch{}a(),r.get("#cookie-consent-banner")?.classList.add("hidden")},acceptSelectedBtn:()=>{if(i.analyticsToggle?.checked){c.set("cookie_consent","accepted"),globalThis.dataLayer=globalThis.dataLayer||[],globalThis.dataLayer.push({event:"consentGranted"}),y.load();try{d?.announce("Cookie-Einstellungen gespeichert: Analyse aktiviert",{priority:"polite"})}catch{}}else{c.set("cookie_consent","rejected"),c.deleteAnalytics();try{d?.announce("Cookie-Einstellungen gespeichert: Analyse deaktiviert",{priority:"polite"})}catch{}}a(),r.get("#cookie-consent-banner")?.classList.add("hidden")},acceptAllBtn:()=>{c.set("cookie_consent","accepted"),globalThis.dataLayer=globalThis.dataLayer||[],globalThis.dataLayer.push({event:"consentGranted"}),y.load();try{d?.announce("Cookie-Einstellungen: Alle Cookies aktiviert",{priority:"polite"})}catch{}a(),r.get("#cookie-consent-banner")?.classList.add("hidden")}}).forEach(([p,u])=>{const l=i[p];l&&!t.has(l)&&(l.addEventListener("click",u),t.set(l,u))});const h=()=>{t.forEach((p,u)=>{try{u.removeEventListener("click",p)}catch{}}),t.clear()};i.cookieView&&(i.cookieView._removeHandlers=h)},s=()=>{if(performance.mark("cookie-settings-open-start"),n=e(),!n.footer||!n.cookieView)return;const i=c.get("cookie_consent");n.analyticsToggle&&(n.analyticsToggle.checked=i==="accepted"),document.documentElement.style.scrollSnapType="none",n.footer.classList.add("footer-expanded"),document.body.classList.add("footer-expanded"),n.footerMin?.classList.add("footer-hidden"),n.footerMax?.classList.remove("footer-hidden"),n.cookieView.classList.remove("hidden"),n.normalContent&&(n.normalContent.style.display="none"),n.triggerBtn&&n.triggerBtn.setAttribute("aria-expanded","true"),requestAnimationFrame(()=>globalThis.scrollTo({top:document.body.scrollHeight,behavior:"auto"})),m.create(f.SCROLL_MARK_DURATION),b.bind(),o(n);try{d?.trapFocus(n.cookieView)}catch(h){g.warn("Focus trap failed",h)}performance.mark("cookie-settings-open-end"),performance.measure("cookie-settings-open","cookie-settings-open-start","cookie-settings-open-end")},a=()=>{n||(n=e()),n?.triggerBtn?.setAttribute("aria-expanded","false"),k()};return{open:s,close:a}})();b.setCloseHandler(()=>A.close());function k(){const n=r.get("#site-footer");if(!n)return;n.classList.remove("footer-expanded"),document.body.classList.remove("footer-expanded"),n.querySelector(".footer-maximized")?.classList.add("footer-hidden"),n.querySelector(".footer-minimized")?.classList.remove("footer-hidden");const t=r.get("#footer-normal-content");t&&(t.style.display="block");const e=r.get("#footer-cookie-view");e&&e.classList.add("hidden"),document.documentElement.style.removeProperty("scroll-snap-type"),globalThis.footerScrollHandler&&(globalThis.footerScrollHandler.expanded=!1),b.unbind();try{e?._removeHandlers?.(),t?._removeHandlers?.()}catch{}try{d?.releaseFocus()}catch(o){g.warn("Focus release failed",o)}}document.addEventListener("footer:requestClose",k);class N{async init(){performance.mark("footer-load-start");const t=r.get("#footer-container");if(!t&&r?.get?.("#site-footer"))return this.updateYears(),this.setupInteractions(),new _().init(),new E().init(),new x().init(),!0;if(!t)return!1;try{if(t.querySelector&&t.querySelector("#site-footer"))return this.updateYears(),this.setupInteractions(),new _().init(),new E().init(),new x().init(),!0}catch{}try{const e=t.dataset.footerSrc||"/content/components/footer/footer",o=["localhost","127.0.0.1"].some(a=>location.hostname.includes(a))||location.hostname.endsWith(".local")?[e+".html",e]:[e,e+".html"];let s;for(const a of o)try{if(s=await fetch(a),s?.ok)break}catch{s=null}if(!s?.ok)throw new Error("Footer load failed");return t.innerHTML=await s.text(),r?.invalidate?.(),this.updateYears(),this.setupInteractions(),new _().init(),new E().init(),new x().init(),document.dispatchEvent(new CustomEvent("footer:loaded",{detail:{timestamp:Date.now()}})),performance.mark("footer-load-end"),performance.measure("footer-load","footer-load-start","footer-load-end"),!0}catch(e){return g.error("Footer load failed",e),!1}}updateYears(){const t=new Date().getFullYear();r.getAll(".current-year").forEach(e=>e.textContent=t)}setupInteractions(){const t=r.get(".newsletter-form-enhanced");t&&t.addEventListener("submit",o=>{o.preventDefault();const s=t.querySelector("#newsletter-email");if(s&&!s.checkValidity()){try{d?.announce("Bitte g\xFCltige E-Mail eingeben",{priority:"assertive"})}catch{}return}const a=t.querySelector('button[type="submit"]');if(a){const i=a.textContent;a.textContent="\u2713",a.disabled=!0,setTimeout(()=>{a.textContent=i,a.disabled=!1},3e3)}t.reset();try{d?.announce("Newsletter abonniert",{priority:"polite"})}catch{}}),document.addEventListener("click",o=>{const s=o.target.closest("[data-cookie-trigger]"),a=o.target.closest("[data-footer-trigger]");if(s){o.preventDefault(),A.open();return}a&&(o.preventDefault(),this.handleFooterTrigger())},{passive:!1});const e=r.get("#threeShowcaseBtn");e&&!e.dataset.init&&(e.dataset.init="1",e.addEventListener("click",()=>{e.classList.add("active"),document.dispatchEvent(new CustomEvent("three-earth:showcase",{detail:{duration:8e3}})),setTimeout(()=>e.classList.remove("active"),8e3)}))}handleFooterTrigger(){globalThis.footerScrollHandler&&globalThis.footerScrollHandler.toggleExpansion(!0)}}class E{expanded=!1;observer=null;_resizeHandler=null;_collapseTimer=null;_lockUntil=0;_userScrollListener=null;_nearBottomPx=24;expandThreshold=.05;collapseThreshold=.02;constructor(){globalThis.footerScrollHandler=this}init(){const t=r.get("#site-footer");let e=r.get("#footer-trigger-zone")||document.getElementById("footer-trigger-zone");if(!e)try{e=document.createElement("div"),e.id="footer-trigger-zone",e.className="footer-trigger-zone",e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),e.style.pointerEvents="none",e.style.minHeight="96px",e.style.width="100%",e.dataset.expandThreshold=e.dataset.expandThreshold||"0.002",e.dataset.collapseThreshold=e.dataset.collapseThreshold||"0.0008",e.dataset.expandLockMs=e.dataset.expandLockMs||"1000",e.dataset.collapseDebounceMs=e.dataset.collapseDebounceMs||"250",t?.parentNode?t.parentNode.insertBefore(e,t):document.body&&document.body.appendChild(e),r?.invalidate?.()}catch(h){try{g.warn("ScrollHandler: failed to create fallback #footer-trigger-zone",h)}catch{}}if(!t||!e){try{g.warn("ScrollHandler: #footer-trigger-zone not found after fallback; aborting init")}catch{}return}t.querySelector(".footer-minimized")?.classList.remove("footer-hidden"),t.querySelector(".footer-maximized")?.classList.add("footer-hidden");const o=globalThis.matchMedia?.("(min-width: 769px)")?.matches,s=o?.003:.05,a=o?.001:.02;this._applyThresholds(e,o,s,a);const i=o?"0px 0px -2% 0px":"0px 0px -10% 0px";this._setupObserver(e,i),this._setupFallbackListener(),this._resizeHandler=S(()=>{this.observer?.disconnect(),this.init()},150),globalThis.addEventListener("resize",this._resizeHandler,{passive:!0})}cleanup(){if(this.observer?.disconnect(),this._resizeHandler&&globalThis.removeEventListener("resize",this._resizeHandler),this._collapseTimer&&(clearTimeout(this._collapseTimer),this._collapseTimer=null),this._userScrollListener){try{globalThis.removeEventListener("wheel",this._userScrollListener),globalThis.removeEventListener("touchstart",this._userScrollListener)}catch{}this._userScrollListener=null}}toggleExpansion(t){let e=r.get("#site-footer");if(e||(e=document.querySelector("#site-footer")),!e)return;try{globalThis._lastToggleCall={ts:Date.now(),shouldExpand:t}}catch{}const o=e.querySelector(".footer-minimized"),s=e.querySelector(".footer-maximized");if(t&&!this.expanded){this._collapseTimer&&(clearTimeout(this._collapseTimer),this._collapseTimer=null,this._scheduledCollapse=!1),this._expandFooter(e,o,s);return}if(!t&&this.expanded){const a=Date.now();if(a<(this._lockUntil||0)){const i=this._lockUntil-a+(this.collapseDebounceMs||f.COLLAPSE_DEBOUNCE_MS);this._scheduleCollapse(i);return}this._scheduleCollapse(this.collapseDebounceMs||f.COLLAPSE_DEBOUNCE_MS)}}_expandFooter(t,e,o){m.create(1e3),b.bind(),document.documentElement.style.scrollSnapType="none";try{t.classList.add("footer-expanded"),t.setAttribute("class",(t.getAttribute("class")||"").split(" ").concat(["footer-expanded"]).filter(Boolean).join(" "))}catch{}try{document.body.classList.add("footer-expanded"),document.body.setAttribute("class",(document.body.getAttribute("class")||"").split(" ").concat(["footer-expanded"]).filter(Boolean).join(" "))}catch{}o?.classList.remove("footer-hidden"),e?.classList.add("footer-hidden"),this.expanded=!0,this._lockUntil=Date.now()+(this.expandLockMs||f.EXPAND_LOCK_MS)}_applyThresholds(t,e,o,s){try{const{expandThreshold:a,collapseThreshold:i,expandLockMs:h,collapseDebounceMs:p}=t.dataset;this.expandThreshold=a?Number.parseFloat(a):o,this.collapseThreshold=i?Number.parseFloat(i):s;const u=h?Number.parseInt(h,10):Number.NaN,l=p?Number.parseInt(p,10):Number.NaN,T=e?1e3:500,L=e?250:200;this.expandLockMs=!Number.isNaN(u)&&u>=0?u:T,this.collapseDebounceMs=!Number.isNaN(l)&&l>=0?l:L}catch{this.expandThreshold=o,this.collapseThreshold=s,this.expandLockMs=e?1e3:500,this.collapseDebounceMs=e?250:200}}_setupObserver(t,e){this.observer=new IntersectionObserver(o=>{const s=o[0];if(!s||!s.isIntersecting&&m.hasActive())return;this._lastIntersectionRatio=s.intersectionRatio,this._lastIsIntersecting=s.isIntersecting;const a=s.isIntersecting&&s.intersectionRatio>=this.expandThreshold;!a&&this.expanded&&s.intersectionRatio>this.collapseThreshold||this.toggleExpansion(a)},{rootMargin:e,threshold:[this.collapseThreshold,this.expandThreshold]}),this.observer.observe(t)}_setupFallbackListener(){this._userScrollListener=t=>{if(m.hasActive()||this.expanded)return;const e=globalThis.scrollY||globalThis.pageYOffset||0;if((globalThis.innerHeight||0)+e>=document.body.scrollHeight-(this._nearBottomPx||24)&&!(t?.type==="wheel"&&typeof t.deltaY=="number"&&t.deltaY<=0))try{this.toggleExpansion(!0)}catch(o){g.warn("fallback scroll expand failed",o)}},globalThis.addEventListener("wheel",this._userScrollListener,{passive:!0}),globalThis.addEventListener("touchstart",this._userScrollListener,{passive:!0})}_scheduleCollapse(t){this._collapseTimer&&clearTimeout(this._collapseTimer),this._scheduledCollapse=!0,this._collapseTimer=setTimeout(()=>{this._scheduledCollapse=!1;const e=this._lastIntersectionRatio??0;if(this._lastIsIntersecting&&e>=this.collapseThreshold){this._collapseTimer=null;return}try{k()}catch(o){g.warn("scheduled close failed",o)}this.expanded=!1,this._collapseTimer=null},t)}}class x{constructor(){this.debouncedApply=S(this.apply.bind(this),f.RESIZE_DEBOUNCE),this._measurementScheduled=!1}init(){globalThis.addEventListener("resize",this.debouncedApply,{passive:!0}),this.apply()}apply(){const t=r.get("#site-footer .footer-enhanced-content");t&&(this._measurementScheduled||(this._measurementScheduled=!0,requestAnimationFrame(()=>{this._measurementScheduled=!1;const e=t.scrollHeight,o=globalThis.innerHeight||0,s=Math.min(Math.max(0,e),o-24);s>0&&document.documentElement.style.setProperty("--footer-actual-height",`${s}px`)})))}}const H=()=>new N().init();export{H as initFooter};
