import{createLogger as le,getElementById as U,onResize as he,TimerManager as de,AppLoadManager as O}from"../../utils/shared-utilities.js";import{getSharedState as ue,loadThreeJS as ge,registerParticleSystem as me,unregisterParticleSystem as fe,sharedCleanupManager as M,sharedParallaxManager as Ee}from"./shared-particle-system.js";import{CONFIG as s}from"./earth/config.js";import{setupScene as pe,setupLighting as ye,createAtmosphere as Se}from"./earth/scene.js";import{createEarthSystem as be,createMoonSystem as Te,createCloudLayer as we}from"./earth/assets.js";import{CameraManager as ve}from"./earth/camera.js";import{StarManager as Me,ShootingStarManager as Ie}from"./earth/stars.js";import{CardManager as Le}from"./earth/cards.js";import{showLoadingState as Y,hideLoadingState as Ae,showErrorState as H,PerformanceMonitor as Pe}from"./earth/ui.js";const o=le("ThreeEarthSystem"),q=new de;let p,b,c,g,i,l,m,x,D,_,I,y,S,w,L,h,G,V,f,j="hero",K="HIGH",k=!1,F=!0,A=null,P=!1,C=null;const T={};let W=!1,B=!1,u=!1;const Q=(()=>{const e=async()=>{if(ue().systems.has("three-earth"))return o.debug("System already initialized"),t;const r=U("threeEarthContainer");if(!r)return o.warn("Container not found"),()=>{};u=!0;try{if(o.info("Initializing Three.js Earth System v11.0.0 (Pure WebGL)"),!$(r)||(ze(),g=await Re(q,r),!u))return t;Y(r),k=!!A?.isMobile||(globalThis.matchMedia?.("(max-width: 768px)")?.matches??!1);const n=pe(g,r);p=n.scene,b=n.camera,c=n.renderer,c&&s.PERFORMANCE?.PIXEL_RATIO&&c.setPixelRatio(s.PERFORMANCE.PIXEL_RATIO);const d=Z(g,r);xe(g,p,b,c);const[E,R,se]=await Oe(g,p,c,k,d);if(!u)return E.dayMaterial&&E.dayMaterial.dispose(),t;i=E.earthMesh,x=E.dayMaterial,D=E.nightMaterial,l=R,m=se,m&&(m.position.copy(i.position),m.scale.copy(i.scale),p.add(m));const ce=Se(g,k);return i.add(ce),Ue(r),et(r),at(),De(r),t}catch(n){o.error("Initialization failed:",n);try{c&&c.dispose()}catch{}return M.cleanupSystem("three-earth"),H(r,n,()=>{t(),e()}),()=>{}}},t=()=>{u=!1,o.info("Cleaning up Earth system");try{globalThis.removeEventListener("mousemove",z),globalThis.removeEventListener("click",N)}catch{}if(C){try{clearTimeout(C)}catch{}C=null}if(P){try{T.cloudSpeed!==void 0&&(s.CLOUDS.ROTATION_SPEED=T.cloudSpeed),T.emissiveAmp!==void 0&&(s.EARTH.EMISSIVE_PULSE_AMPLITUDE=T.emissiveAmp)}catch{}P=!1}f&&(cancelAnimationFrame(f),f=null),document.removeEventListener("visibilitychange",re),L?.cleanup(),w?.cleanup(),y?.cleanup(),S?.cleanup(),G?.disconnect(),V?.disconnect(),q.clearAll(),M.cleanupSystem("three-earth"),p&&(p.traverse(r=>{r.geometry&&r.geometry.dispose(),r.material&&(Array.isArray(r.material)?r.material.forEach(n=>a(n)):a(r.material))}),p.clear()),c&&c.dispose(),[x,D].forEach(a),p=b=c=null,i=l=m=null,x=D=null,_=I=null,W=!1,B=!1,h&&h.cleanup(),h=S=w=L=null,y=null,fe("three-earth"),document.body.classList.remove("three-earth-active"),o.info("Cleanup complete")};function a(r){r&&(["map","normalMap","bumpMap","envMap","emissiveMap","alphaMap"].forEach(n=>{r[n]?.dispose&&(r[n].dispose(),r[n]=null)}),r.uniforms&&Object.values(r.uniforms).forEach(n=>{n?.value&&typeof n.value.dispose=="function"&&n.value.dispose()}),r.dispose())}return{initThreeEarth:e,cleanup:t}})();function Ce(){try{const e=document.createElement("canvas"),t=e.getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(t){try{t.getExtension?.("EXT_color_buffer_float")}catch(a){o.warn("getExtension ignored",a)}return!0}return!!(e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl"))}catch{return!1}}let J=!1;async function Re(e,t){let a=null,r=!1;try{a=e.setTimeout(()=>{if(!r){o.warn("Three.js load taking too long \u2014 unblocking three-earth to avoid blocking global loader");try{O.unblock("three-earth")}catch(d){o.warn("AppLoadManager.unblock ignored",d)}try{H(t,new Error("Three.js load timeout"),()=>{oe(),ie()})}catch(d){o.warn("showErrorState fallback ignored",d)}}},8e3)}catch(d){o.warn("start watchdog ignored",d)}const n=await ge();r=!0;try{a&&e.clearTimeout(a)}catch(d){o.warn("clear watchdog timer failed",d)}return n}function Z(e,t){const a=new e.LoadingManager;return a.onProgress=(r,n,d)=>{if(u)try{const E=Math.min(1,n/Math.max(1,d));Y(t,E)}catch(E){o.debug("onProgress UI update failed",E)}},a.onLoad=()=>{if(u){W=!0;try{t.dataset.threeReady="1",document.dispatchEvent(new CustomEvent("three-ready",{detail:{containerId:t?.id??null}}));try{window.dispatchEvent(new Event("earth-ready"))}catch(r){o.warn("earth-ready dispatch failed",r)}}catch(r){o.warn("three-ready dispatch failed",r)}}},a.onError=r=>{o.warn("Error loading texture:",r);try{O.unblock("three-earth")}catch{}try{window.dispatchEvent(new Event("earth-ready"))}catch(n){o.warn("earth-ready dispatch onError failed",n)}},a}function X(){try{const e=(navigator.userAgent||"").toLowerCase(),t=/mobile|tablet|android|ios|iphone|ipad/i.test(e),a=/android 4|android 5|cpu iphone os 9|cpu iphone os 10/i.test(e)||(navigator.hardwareConcurrency||4)<=2;let r;return a?r="LOW":t?r="MEDIUM":r="HIGH",{isMobile:t,isLowEnd:a,recommendedQuality:r}}catch{return{isMobile:!1,isLowEnd:!1,recommendedQuality:"MEDIUM"}}}async function Oe(e,t,a,r,n){return Promise.all([be(e,t,a,r,n),Te(e,t,a,r,n),we(e,a,n,r)])}function xe(e,t,a,r){try{S=new Me(e,t,a,r);const n=S.createStarField(),d=R=>{!n||!S||S.transition?.active||(n.rotation.y=R*Math.PI*.2,n.position.z=Math.sin(R*Math.PI)*15)};Ee.addHandler(d,"three-earth-stars");const E=ye(e,t);_=E.directionalLight,I=E.ambientLight}catch(n){o.warn("Stars/Lighting initialization ignored",n)}}function De(e){Xe(),$e(),Je(),o.info("Initialization complete");try{if(!e.dataset.threeReady){e.dataset.threeReady="1",document.dispatchEvent(new CustomEvent("three-ready",{detail:{containerId:e?.id??null}}));try{window.dispatchEvent(new Event("earth-ready"))}catch(t){o.warn("earth-ready dispatch fallback failed",t)}}}catch(t){o.warn("Failed to set fallback three-ready",t)}}function _e(e,t){try{globalThis.removeEventListener("mousemove",e),globalThis.removeEventListener("click",t)}catch{}globalThis.addEventListener("mousemove",e),globalThis.addEventListener("click",t),M.addCleanupFunction("three-earth",()=>{globalThis.removeEventListener("mousemove",e),globalThis.removeEventListener("click",t)},"interaction")}function ke(){try{A=X();const e=ee(A);Object.assign(s,e)}catch(e){o.debug("Device detection failed, using defaults",e)}}function Fe(e,t){if(!J){if(J=!0,!t&&!Ce()){o.warn("WebGL not supported in this environment; skipping Three.js initialization");try{if(e.classList.add("three-earth-unavailable"),!e.querySelector(".three-earth-fallback")){const a=document.createElement("div");a.className="three-earth-fallback",a.setAttribute("role","img"),a.setAttribute("aria-label","Interaktive Darstellung wird nicht unterst\xFCtzt. Statische Vorschau angezeigt."),a.innerHTML=`
            <div class="three-earth-fallback__inner">
              <picture>
                <source type="image/avif" srcset="/content/assets/img/og/og-home@1600.avif 1600w, /content/assets/img/og/og-home@1200.avif 1200w, /content/assets/img/og/og-home@800.avif 800w, /content/assets/img/og/og-home@400.avif 400w" sizes="(max-width:1200px) 100vw, 1200px" />
                <source type="image/webp" srcset="/content/assets/img/og/og-home@1600.webp 1600w, /content/assets/img/og/og-home@1200.webp 1200w, /content/assets/img/og/og-home@800.webp 800w, /content/assets/img/og/og-home@400.webp 400w" sizes="(max-width:1200px) 100vw, 1200px" />
                <img src="/content/assets/img/og/og-home@1200.avif" srcset="/content/assets/img/og/og-home@1600.avif 1600w, /content/assets/img/og/og-home@1200.avif 1200w, /content/assets/img/og/og-home@800.avif 800w" sizes="(max-width:1200px) 100vw, 1200px" alt="Abdulkerim \u2014 Digital Creator Portfolio" width="1200" height="630" decoding="async" loading="eager" fetchpriority="high" />
              </picture>
              <p class="three-earth-fallback__text">Interaktive 3D\u2011Ansicht wird von Ihrem Ger\xE4t nicht unterst\xFCtzt. Hier eine Vorschau.</p>
            </div>
          `,e.appendChild(a)}}catch(a){o.warn("DOM insert ignored",a)}return H(e,new Error("WebGL nicht verf\xFCgbar oder blockiert")),M.cleanupSystem("three-earth"),!1}t&&o.info("Force flag detected: attempting to initialize Three.js despite WebGL checks")}return!0}function $(e){try{ke()}catch(a){o.debug("Device detection failed in _detectAndEnsureWebGL",a)}const t=new URL(location.href).searchParams.get("forceThree")==="1"||!!globalThis.__FORCE_THREE_EARTH;return Fe(e,t)}function ze(){me("three-earth",{type:"three-earth"});try{O.block("three-earth")}catch(e){o.warn("AppLoadManager.block/unblock ignored",e)}}function Ne(e){u=!!e}function Ue(e){y=new ve(g,b),y.setupCameraSystem();const t=a=>{u&&y?.handleWheel(a)};e.addEventListener("wheel",t,{passive:!0}),M.addCleanupFunction("three-earth",()=>e.removeEventListener("wheel",t),"wheel control")}function ee(e){return e?e.isLowEnd?{EARTH:{...s.EARTH,SEGMENTS:24,SEGMENTS_MOBILE:16},STARS:{...s.STARS,COUNT:1e3},PERFORMANCE:{...s.PERFORMANCE,PIXEL_RATIO:1,TARGET_FPS:30},CLOUDS:{...s.CLOUDS,OPACITY:0}}:e.isMobile?{EARTH:{...s.EARTH,SEGMENTS_MOBILE:32},STARS:{...s.STARS,COUNT:2e3},PERFORMANCE:{...s.PERFORMANCE,PIXEL_RATIO:Math.min(globalThis.devicePixelRatio||1,2)}}:{}:{}}function He(){const e=Array.from(document.querySelectorAll("section[id], div#footer-trigger-zone"));if(e.length===0)return;const t=Array.from({length:21},(a,r)=>r/20);G=new IntersectionObserver(te,{rootMargin:"-20% 0px -20% 0px",threshold:t}),e.forEach(a=>G.observe(a))}function Ge(e){V=new IntersectionObserver(We,{threshold:0}),V.observe(e);try{const t=e.getBoundingClientRect();t.top<globalThis.innerHeight&&t.bottom>0&&t.left<globalThis.innerWidth&&t.right>0&&(F=!0,!f&&v&&u&&v())}catch(t){o.debug("Immediate visibility check failed",t)}}function Ve(e,t={}){if(!i||!u)return;const a=!!t.allowModeSwitch,r=je(e);if(Be(r),a){const n=i.userData.currentMode==="night"?"day":"night";i.material=n==="day"?x:D,i.material.needsUpdate=!0,i.userData.currentMode=n,y?.setTargetOrbitAngle(n==="day"?0:Math.PI)}if(_&&I){const n=i.userData.currentMode==="day"?s.LIGHTING.DAY:s.LIGHTING.NIGHT;_.intensity=n.SUN_INTENSITY,I.intensity=n.AMBIENT_INTENSITY,I.color.setHex(n.AMBIENT_COLOR)}}function je(e){const t={hero:{earth:{pos:{x:1,y:-2.5,z:-1},scale:1.3,rotation:0},moon:{pos:{x:-45,y:-45,z:-90},scale:.4},mode:"day"},features:{earth:{pos:{x:-7,y:-2,z:-4},scale:.7,rotation:0},moon:{pos:{x:1,y:2,z:-5},scale:1.1},mode:"day"},section3:{earth:{pos:{x:-1,y:-.5,z:-1},scale:1,rotation:Math.PI},moon:{pos:{x:-45,y:-45,z:-90},scale:.4},mode:"night"},contact:{earth:{pos:{x:0,y:-1.5,z:0},scale:1.1,rotation:Math.PI/2},moon:{pos:{x:-45,y:-45,z:-90},scale:.4},mode:"day"}};return t[e==="site-footer"?"contact":e]||t.hero}function te(e){let t=null;for(const r of e)(!t||r.intersectionRatio>t.intersectionRatio)&&(t=r);if(!t?.isIntersecting)return;t.target.id==="features"&&h&&h.setProgress(t.intersectionRatio||0);const a=ae(t.target.id||"");if(a&&a!==j){const r=j;j=a,y?.updateCameraForSection(a),Ve(a,{allowModeSwitch:r==="features"&&a==="section3"}),a==="features"?h?.setProgress(1):r==="features"&&h?.setProgress(0);const n=document.querySelector(".three-earth-container");n&&(n.dataset.section=a)}}function We(e){if(F=e[0].isIntersecting,F){!f&&v&&(o.debug("Container visible: resuming render loop"),v());return}f&&(o.debug("Container hidden: pausing render loop"),cancelAnimationFrame(f),f=null)}function ae(e){return e==="footer-trigger-zone"?"site-footer":e}function Be(e){e&&(i.userData.targetPosition=new g.Vector3(e.earth.pos.x,e.earth.pos.y,e.earth.pos.z),i.userData.targetScale=e.earth.scale,i.userData.targetRotation=e.earth.rotation,l&&e.moon&&(l.userData.targetPosition=new g.Vector3(e.moon.pos.x,e.moon.pos.y,e.moon.pos.z),l.userData.targetScale=e.moon.scale))}let v;function re(){if(document.hidden){f&&(cancelAnimationFrame(f),f=null);return}!f&&v&&F&&u&&v()}function Xe(){const e=new g.Clock,t=A||X(),a=t.isLowEnd?2:1;let r=0;v=()=>{if(!u||(f=requestAnimationFrame(v),r++,r%a!==0))return;const n=e.getElapsedTime();Ye(r,n,t),qe(n,r,t),Ke(n,t),Qe()},document.addEventListener("visibilitychange",re),document.visibilityState==="visible"&&v()}function Ye(e,t,a){m&&e%2===0&&(m.rotation.y+=s.CLOUDS.ROTATION_SPEED),l&&e%3===0&&(l.rotation.y+=s.MOON.ORBIT_SPEED),a.isLowEnd||S?.update(t)}function qe(e,t,a){if(i?.userData.currentMode==="night"&&!a.isLowEnd&&t%2===0){const r=s.EARTH.EMISSIVE_INTENSITY*4,n=Math.sin(e*s.EARTH.EMISSIVE_PULSE_SPEED)*s.EARTH.EMISSIVE_PULSE_AMPLITUDE*2;i?.material&&(i.material.emissiveIntensity=r+n)}}function Ke(e,t){y?.updateCameraPosition(),Ze(),h&&globalThis.lastMousePos&&h.update(e*1e3,globalThis.lastMousePos),t.isLowEnd||w?.update(),L&&L.update()}function Qe(){if(c&&p&&b){c.render(p,b);try{if(W&&!B){B=!0;const e=U("threeEarthContainer");try{o.info("First rendered frame \u2014 hiding loader and unblocking three-earth")}catch{}try{Ae(e)}catch(t){o.debug("post-render loader hide failed",t)}try{O.unblock("three-earth")}catch(t){o.warn("[ThreeEarthSystem] AppLoadManager.unblock failed on first frame",t)}try{document.dispatchEvent(new CustomEvent("three-first-frame",{detail:{containerId:e?.id??null}}))}catch(t){o.warn("three-first-frame dispatch failed",t)}}}catch(e){o.debug("post-render loader hide failed",e)}}}let z,N;function Je(){globalThis.lastMousePos=new g.Vector2(-999,-999),z||(z=e=>{u&&(globalThis.lastMousePos.x=e.clientX/globalThis.innerWidth*2-1,globalThis.lastMousePos.y=-(e.clientY/globalThis.innerHeight)*2+1)}),N||(N=e=>{if(!u||!h)return;const t=new g.Vector2;t.x=e.clientX/globalThis.innerWidth*2-1,t.y=-(e.clientY/globalThis.innerHeight)*2+1,h.handleClick(t)}),_e(z,N)}function Ze(){if(i){if(i.userData.targetPosition&&i.position.lerp(i.userData.targetPosition,.04),i.userData.targetScale&&(i.scale.x+=(i.userData.targetScale-i.scale.x)*.06,i.scale.y=i.scale.z=i.scale.x),i.userData.targetRotation!==void 0){const e=i.userData.targetRotation-i.rotation.y;Math.abs(e)>.001&&(i.rotation.y+=e*.06)}m&&i&&(m.position.copy(i.position),m.scale.copy(i.scale)),l&&(l.userData.targetPosition&&l.position.lerp(l.userData.targetPosition,.04),l.userData.targetScale&&(l.scale.x+=(l.userData.targetScale-l.scale.x)*.06,l.scale.y=l.scale.z=l.scale.x))}}function $e(){const e=he(()=>{const t=U("threeEarthContainer");if(!t||!b||!c)return;const a=t.clientWidth,r=t.clientHeight;k=globalThis.matchMedia?.("(max-width: 768px)")?.matches??!1,b.aspect=a/r,b.updateProjectionMatrix(),c.setSize(a,r),S&&S.handleResize(a,r)},100);M.addCleanupFunction("three-earth",e,"resize handler")}function et(e){He(),Ge(e),document.body.classList.add("three-earth-active"),L=new Pe(e,c,r=>{K=r;const n=s.QUALITY_LEVELS[K];m&&(m.visible=n.cloudLayer),w&&(w.disabled=!n.meteorShowers);try{c&&s.PERFORMANCE?.PIXEL_RATIO&&c.setPixelRatio(s.PERFORMANCE.PIXEL_RATIO)}catch(d){o.debug("Unable to set PIXEL_RATIO during quality apply",d)}}),w=new Ie(p,g);const t=[{title:"\xDCber mich",subtitle:"\xDCBER MICH",text:"Kurz & knapp: Wer ich bin, was mich antreibt und meine Vision.",link:"/about/",iconChar:"\u{1F468}\u200D\u{1F4BB}",color:"#07a1ff"},{title:"Projekte",subtitle:"PROJEKTE",text:"Auswahl an Projekten \u2014 Konzept, Umsetzung und Ergebnis.",link:"/projekte/",iconChar:"\u{1F680}",color:"#a107ff"},{title:"Fotos",subtitle:"FOTOS",text:"Ausschnitte aus meiner Sicht der Welt.",link:"/gallery/",iconChar:"\u{1F4F8}",color:"#ff07a1"}];h=new Le(g,p,b,c),S&&typeof S.setCardManager=="function"&&S.setCardManager(h),h.initFromData(t);const a=r=>{r.detail?.id==="features"&&h&&h.initFromData(t)};document.addEventListener("section:loaded",a),M.addCleanupFunction("three-earth",()=>document.removeEventListener("section:loaded",a),"section listener")}function tt(e=8e3){if(!u||P||A?.isLowEnd)return;P=!0,T.cloudSpeed=s.CLOUDS.ROTATION_SPEED,T.emissiveAmp=s.EARTH.EMISSIVE_PULSE_AMPLITUDE,s.CLOUDS.ROTATION_SPEED=T.cloudSpeed*3,s.EARTH.EMISSIVE_PULSE_AMPLITUDE=T.emissiveAmp*3;try{const a=y?.cameraOrbitAngle||0;y?.setTargetOrbitAngle(a+Math.PI/2)}catch{}const t=Math.max(2,Math.floor(e/2e3));for(let a=0;a<t;a++)setTimeout(()=>w?.triggerShower(),a*1200);if(i){const a=i.scale.x||1;i.userData.targetScale=a*1.06,setTimeout(()=>{i&&(i.userData.targetScale=a)},e-300)}C=setTimeout(()=>{s.CLOUDS.ROTATION_SPEED=T.cloudSpeed||s.CLOUDS.ROTATION_SPEED,s.EARTH.EMISSIVE_PULSE_AMPLITUDE=T.emissiveAmp||s.EARTH.EMISSIVE_PULSE_AMPLITUDE,P=!1,C=null},e)}function ne(e){try{const t=e?.detail?.duration??8e3;tt(t)}catch(t){o.warn("Showcase trigger failed",t)}}function at(){document.addEventListener("three-earth:showcase",ne),M.addCleanupFunction("three-earth",()=>document.removeEventListener("three-earth:showcase",ne),"showcase listener")}const{initThreeEarth:ie,cleanup:oe}=Q,rt={flyToPreset:e=>{y&&y.flyToPreset(e)},triggerMeteorShower:()=>{w?.triggerShower()},getConfig:()=>s,updateConfig:e=>{Object.assign(s,e)},get shootingStarManager(){return w}};var nt=Q;export{rt as EarthSystemAPI,Ne as __setIsSystemActive,Z as _createLoadingManager,$ as _detectAndEnsureWebGL,ae as _mapId,te as _onSectionObserverEntries,oe as cleanup,nt as default,X as detectDeviceCapabilities,ee as getOptimizedConfig,ie as initThreeEarth};
