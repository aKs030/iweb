import{CONFIG as c}from"./config.js";import{createLogger as h,throttle as y}from"../../../utils/shared-utilities.js";import{calculateQualityLevel as v,calculateDynamicResolution as m}from"./ui_helpers.js";const s=h("EarthUI");function u(){const r=document.getElementById("app-loader"),e=document.getElementById("loader-status-text");return r?{overlay:r,text:e}:null}function f(r,e){if(!r)return;const t=u();if(t?.overlay){if(t.overlay.dataset.loaderDone==="true")return;if(t.overlay.classList.remove("fade-out","hidden"),t.overlay.removeAttribute("aria-hidden"),t.overlay.setAttribute("aria-live","polite"),t.overlay.setAttribute("role","status"),Object.assign(t.overlay.style,{display:"flex",opacity:"1",pointerEvents:"auto",visibility:"visible"}),t.text)if(typeof e=="number"){const a=Math.round(e*100);t.text.textContent=`L\xE4dt 3D\u2011Ansicht\u2026 (${a}%)`}else t.text.textContent="Initialisiere 3D-Engine...";typeof e=="number"?(t.overlay.setAttribute("aria-valuenow",String(Math.round(e*100))),t.overlay.setAttribute("aria-valuemin","0"),t.overlay.setAttribute("aria-valuemax","100")):(t.overlay.removeAttribute("aria-valuenow"),t.overlay.removeAttribute("aria-valuemin"),t.overlay.removeAttribute("aria-valuemax"));try{document.body.classList.add("global-loading-visible")}catch(a){s.warn("EarthUI: add global-loading-visible failed",a)}}}function d(r){if(!r)return;const e=u();e?.overlay&&(e.overlay.classList.add("fade-out"),e.overlay.setAttribute("aria-hidden","true"),e.overlay.removeAttribute("aria-live"),setTimeout(()=>{e.overlay&&(e.overlay.style.display="none");try{document.body.classList.remove("global-loading-visible")}catch(t){s.warn("EarthUI: remove global-loading-visible failed",t)}},800))}function b(r,e,t){if(!r)return;const a=u();a?.overlay&&(a.overlay.classList.add("fade-out"),d(r)),r.classList.add("error");const o=r.querySelector(".three-earth-error");if(o){o.classList.remove("hidden");const l=o.querySelector("p");if(l){const n=e?.message||"Unknown error";l.textContent=`WebGL Fehler: ${n}`}let i=o.querySelector(".three-earth-retry");!i&&t&&(i=document.createElement("button"),i.className="retry-btn three-earth-retry",i.type="button",i.textContent="Neu versuchen",i.addEventListener("click",async()=>{try{await t()}catch(n){s.error("Retry failed:",n),l&&(l.textContent=`Fehler: ${n.message}`)}}),o.appendChild(i))}}class p{constructor(e,t,a){this.renderer=t,this.onQualityChange=a,this.frame=0,this.lastTime=performance.now(),this.fps=60,this.currentPixelRatio=c.PERFORMANCE.PIXEL_RATIO,this.currentQualityLevel="HIGH",this.throttledAdjustResolution=y(()=>this.adjustResolution(),1e3)}update(){this.frame++;const e=performance.now();e>=this.lastTime+1e3&&(this.fps=this.frame*1e3/(e-this.lastTime),this.lastTime=e,this.frame=0,this.throttledAdjustResolution())}adjustResolution(){const e=v(this.fps);e!==this.currentQualityLevel&&(this.currentQualityLevel=e,this.onQualityChange&&this.onQualityChange(this.currentQualityLevel));const t=m(this.fps,this.currentPixelRatio,c.PERFORMANCE);if(t!==this.currentPixelRatio){s.info(`Adjusting pixel ratio: ${this.currentPixelRatio} -> ${t}`),this.currentPixelRatio=t;try{this.renderer.setPixelRatio(this.currentPixelRatio)}catch(a){s.warn("Failed to set pixel ratio on renderer:",a)}}}cleanup(){}}export{p as PerformanceMonitor,d as hideLoadingState,b as showErrorState,f as showLoadingState};
