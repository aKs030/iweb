import{createLogger as v}from"../../../utils/shared-utilities.js";const _=v("CardManager");class M{constructor(e,r,t,i){this.THREE=e,this.scene=r,this.camera=t,this.renderer=i,this.cards=[],this.raycaster=new e.Raycaster,this.isVisible=!1,this._hovered=null,this._hoverCandidate=null,this._hoverFrames=0,this._resizeRAF=null,this._sharedGeometry=null,this._sharedGlowTexture=null,this._tmpVec=new e.Vector3,this._tmpQuat=new e.Quaternion,this._tmpQuat2=new e.Quaternion,this._tmpEuler=new e.Euler,this._orientDummy=new e.Object3D,this.cardGroup=new e.Group,this.scene.add(this.cardGroup),this.cardGroup.visible=!1,this._textureCache=new Map,this._profile={texturesCreated:0,texturesDisposed:0,cacheHits:0,cacheMisses:0},this._lastPointerPos={x:0,y:0},this._pointerDown=!1,this._pointerDownPos=null,this._boundPointerMove=null,this._boundPointerDown=null,this._boundPointerUp=null}_pixelsToWorldY(e){if(!this.renderer||!this.camera)return 0;const r=this.renderer.domElement.getBoundingClientRect().height||(globalThis.window?.innerHeight??800);if(!r)return 0;const t=e/r*2,i=new this.THREE.Vector3(0,0,.5),a=new this.THREE.Vector3(0,-t,.5);return i.unproject(this.camera),a.unproject(this.camera),a.y-i.y}initFromData(e){if(this.cards.length>0||!Array.isArray(e)||e.length===0)return;_.debug(`Initializing ${e.length} cards from data`);const r=e.length,t=2.2,i=2.8,a=t*(r>2?1.4:1.25),o=(r-1)/2;this._baseW=t,this._baseH=i;const l=e.map((n,h)=>({x:(h-o)*a,y:0,z:0,color:n.color||["#07a1ff","#a107ff","#ff07a1"][h]||"#ffffff"}));this._sharedGeometry=new this.THREE.PlaneGeometry(t,i),this._sharedGlowTexture||(this._sharedGlowTexture=this.createGlowTexture()),e.forEach((n,h)=>{const s={id:h,title:n.title||"",subtitle:n.subtitle||"",text:n.text||"",link:n.link||"#",iconChar:n.iconChar||"",color:l[h].color,position:l[h]},c=this._createMeshFromData(s,h,t,i);this.cardGroup.add(c),this.cards.push(c)}),this.isVisible&&(this.cardGroup.visible=!0),this._onResize=()=>{this._resizeRAF&&cancelAnimationFrame(this._resizeRAF),this._resizeRAF=requestAnimationFrame(()=>{const n=window.innerWidth,h=n<768;this.cards.forEach((s,c)=>{if(h){const d=(o-c)*2.9,p=this._pixelsToWorldY(76);s.scale.setScalar(.82),s.position.x=0;const u=d-p;s.position.y=u,s.userData.originalY=u,s.userData.hoverY=u+.2}else{const d=Math.min(1,n/1200),p=t*(r>2?1.4:1.25)*Math.max(.85,d),u=(c-o)*p;s.scale.setScalar(.95*Math.max(.65,d)),s.position.x=u,s.position.y=0,s.userData.originalY=0,s.userData.hoverY=.5}}),this._resizeRAF=null})},globalThis.window!==void 0&&(window.addEventListener("resize",this._onResize),this._onResize())}getCardScreenRects(){if(!this.renderer||!this.camera||this.cards.length===0)return[];const e=this.renderer.domElement.getBoundingClientRect(),r=e.width,t=e.height,i=new this.THREE.Vector3,a=new this.THREE.Vector3;return this.cards.map(o=>{o.updateMatrixWorld(),o.getWorldPosition(i),i.project(this.camera);const l=(i.x*.5+.5)*r+e.left,n=(-i.y*.5+.5)*t+e.top,h=(this._baseW||2.2)*.5*o.scale.x,s=(this._baseH||2.8)*.5*o.scale.y;a.set(h,0,0).applyMatrix4(o.matrixWorld),a.project(this.camera);const c=(a.x*.5+.5)*r+e.left;a.set(0,s,0).applyMatrix4(o.matrixWorld),a.project(this.camera);const d=(-a.y*.5+.5)*t+e.top,p=Math.min(l,c)-Math.abs(c-l),u=Math.max(l,c),x=Math.min(n,d)-Math.abs(d-n),f=Math.max(n,d);return{left:p,top:x,right:u,bottom:f}})}createCardTexture(e){const r=globalThis.window?.devicePixelRatio?globalThis.window.devicePixelRatio:1,t=Math.min(Math.max(Math.ceil(r*2),2),4),i=512*t,a=700*t,o={title:(e.title||"").slice(0,256),subtitle:(e.subtitle||"").slice(0,128),text:(e.text||"").slice(0,512),iconChar:e.iconChar||"",color:e.color||"#ffffff",DPR:Math.round(r*100)},l=JSON.stringify(o),n=this._textureCache.get(l);if(n?.texture)return n.count++,this._profile.cacheHits++,n.texture;this._profile.cacheMisses++;const h=typeof OffscreenCanvas>"u"?document.createElement("canvas"):new OffscreenCanvas(i,a);typeof OffscreenCanvas>"u"&&(h.width=i,h.height=a);const s=h.getContext("2d");if(!s){_.warn("CardManager: 2D canvas context unavailable; returning empty texture");const y=new this.THREE.CanvasTexture(h);return y.needsUpdate=!0,y}const c=s.createLinearGradient(0,0,i,a);c.addColorStop(0,"rgba(20, 30, 60, 0.9)"),c.addColorStop(1,"rgba(10, 15, 30, 0.95)"),s.fillStyle=c;const d=40*t;this.roundRect(s,0,0,i,a,d),s.fill(),this.drawStarBorder(s,0,0,i,a,d,t);const p=150*t,u=256*t,x=60*t;s.fillStyle="rgba(255, 255, 255, 0.05)",s.beginPath(),s.arc(u,p,x,0,Math.PI*2),s.fill(),s.strokeStyle=e.color,s.lineWidth=2*t,s.stroke(),s.fillStyle="#ffffff",s.font=`${60*t}px "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", Arial, sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(e.iconChar,u,p+5*t),s.fillStyle=e.color;const f=(e.subtitle||"").trim(),T=this.fitTextToWidth(s,f,420*t,"bold",24*t,12*t,'Arial, "Helvetica Neue", sans-serif');s.font=`bold ${T}px Arial, "Helvetica Neue", sans-serif`,s.fillText(f,u,280*t),s.fillStyle="#ffffff";const g=(e.title||"").trim(),w=this.fitTextToWidth(s,g,420*t,"bold",48*t,20*t,'Arial, "Helvetica Neue", sans-serif');s.font=`bold ${w}px Arial, "Helvetica Neue", sans-serif`,s.fillText(g,u,350*t),s.fillStyle="#cccccc";const b=e.text&&e.text.length>160?Math.max(18*t,22*t):30*t;s.font=`${b}px Arial, "Helvetica Neue", sans-serif`,this.wrapText(s,e.text,u,450*t,400*t,Math.round(40*t));const m=new this.THREE.CanvasTexture(h);return m.generateMipmaps=!0,m.minFilter=this.THREE.LinearMipmapLinearFilter,m.magFilter=this.THREE.LinearFilter,m.anisotropy=this.renderer?.capabilities?.getMaxAnisotropy?.()??0,m.needsUpdate=!0,this._textureCache.set(l,{texture:m,count:1}),this._profile.texturesCreated++,m}createGlowTexture(){const e=globalThis.devicePixelRatio?Math.min(globalThis.devicePixelRatio,2):1,r=Math.floor(128*e),t=typeof OffscreenCanvas>"u"?document.createElement("canvas"):new OffscreenCanvas(r,r);typeof OffscreenCanvas>"u"&&(t.width=r,t.height=r);const i=t.getContext("2d");if(!i){_.warn("CardManager: 2D canvas context unavailable for glow; returning empty texture");const s=new this.THREE.CanvasTexture(t);return s.needsUpdate=!0,s}const a=r/2,o=r/2,l=r*.45,n=i.createRadialGradient(a,o,l*.1,a,o,l);n.addColorStop(0,"rgba(255,255,255,0.9)"),n.addColorStop(.3,"rgba(255,255,255,0.45)"),n.addColorStop(1,"rgba(255,255,255,0)"),i.fillStyle=n,i.beginPath(),i.arc(a,o,l,0,Math.PI*2),i.fill();const h=new this.THREE.CanvasTexture(t);return h.generateMipmaps=!0,h.minFilter=this.THREE.LinearMipmapLinearFilter,h.magFilter=this.THREE.LinearFilter,h.needsUpdate=!0,h}roundRect(e,r,t,i,a,o){i<2*o&&(o=i/2),a<2*o&&(o=a/2),e.beginPath(),e.moveTo(r+o,t),e.arcTo(r+i,t,r+i,t+a,o),e.arcTo(r+i,t+a,r,t+a,o),e.arcTo(r,t+a,r,t,o),e.arcTo(r,t,r+i,t,o),e.closePath()}drawStarBorder(e,r,t,i,a,o,l){e.strokeStyle="rgba(255, 255, 255, 0.15)",e.lineWidth=1.5,this.roundRect(e,r,t,i,a,o),e.stroke();const n=Math.min(200,Math.max(20,Math.floor(60*l)));e.save();for(let h=0;h<n;h++){const s=Math.floor(Math.random()*4);let c,d;s===0?(c=r+Math.random()*i,d=t):s===1?(c=r+i,d=t+Math.random()*a):s===2?(c=r+Math.random()*i,d=t+a):(c=r,d=t+Math.random()*a);const p=Math.random()*1.5+.5;e.fillStyle=Math.random()>.7?e.strokeStyle:"#ffffff",e.globalAlpha=Math.random()*.8+.2,e.beginPath(),e.arc(c,d,p,0,Math.PI*2),e.fill()}e.restore()}wrapText(e,r,t,i,a,o){const l=(r||"").split(" ");let n="",h=0;const s=4;for(let c=0;c<l.length;c++){const d=n+l[c]+" ";if(e.measureText(d).width>a&&c>0){if(e.fillText(n,t,i),n=l[c]+" ",i+=o,h++,h>=s){n+="...";break}}else n=d}e.fillText(n,t,i)}fitTextToWidth(e,r,t,i="normal",a=24,o=12,l="Arial, sans-serif"){if(!r)return a;let n=a;for(e.textAlign="center",e.textBaseline="middle";n>=o&&(e.font=`${i} ${Math.round(n)}px ${l}`,!(e.measureText(r).width<=t));)n-=1;return Math.max(o,Math.round(n))}setVisible(e){this.isVisible=e,this.setProgress(e?1:0)}setProgress(e){const r=Math.max(0,Math.min(1,typeof e=="number"&&!Number.isNaN(e)?e:0)),t=this.cardGroup.visible;this.cardGroup.visible=r>.01,this.cardGroup.visible&&!t&&this.alignCardsToCameraImmediate(),this.cards.forEach(i=>{const a=(i.userData.entranceDelay||0)/800,o=Math.max(0,Math.min(1,(r-a)/Math.max(1e-4,1-a)));i.userData.entranceTarget=o,i.userData.targetOpacity=o>0?1:0})}getHoveredCardFromScreen(e){if(!this.raycaster||!this.camera)return null;this.raycaster.setFromCamera(e,this.camera);const r=this.raycaster.intersectObjects(this.cards,!1);return r.length>0?r[0].object:null}update(e,r){if(!this.cardGroup.visible)return;const t=r||this._lastPointerPos||{x:0,y:0},i=this.getHoveredCardFromScreen(t);i===this._hoverCandidate?(this._hoverFrames++,this._hoverFrames>=3&&i!==this._hovered&&(this._hovered=i,document.body.style.cursor=i?"pointer":"")):(this._hoverCandidate=i,this._hoverFrames=0);const a=this._hovered;this.camera.getWorldPosition(this._tmpVec),this.cards.forEach(o=>{this._updateCardEntranceAndOpacity(o),this._updateCardHoverTiltAndMotion(o,t,a,e),this._applyOrientation(o),this._updateCardGlow(o,e)}),!this.isVisible&&this.cards[0]&&this.cards[0].material.opacity<.01&&(this.cardGroup.visible=!1)}_updateCardEntranceAndOpacity(e){let r;typeof e.userData.entranceTarget=="number"?r=e.userData.entranceTarget:r=this.isVisible?1:0,e.userData.entranceProgress+=(r-e.userData.entranceProgress)*.02;const t=e.userData.targetOpacity||1;e.material.opacity=t*(.05+.95*e.userData.entranceProgress)}_updateCardHoverTiltAndMotion(e,r,t,i){const a=Math.sin(i*.001+e.userData.id)*.06*(1-e.userData.hoverProgress*.7),o=e===t;let l=o?1:0;!o&&e.userData.hoverProgress>.5&&(l=e.userData.hoverProgress),e.userData.hoverProgress+=(l-e.userData.hoverProgress)*.04;const n=e.userData.parallaxStrength||.12,h=-r.y*n*e.userData.hoverProgress,s=r.x*n*e.userData.hoverProgress*.8;e.userData.currentTiltX+=(h-e.userData.currentTiltX)*.04,e.userData.currentTiltY+=(s-e.userData.currentTiltY)*.04;let c=e.userData.originalY,d=1;e===t&&(c=e.userData.hoverY,d=1.05),e.position.y+=(c+a-e.position.y)*.04,e.scale.setScalar(e.scale.x+(d-e.scale.x)*.04)}_applyOrientation(e){this._orientDummy.position.copy(e.position),this._orientDummy.lookAt(this._tmpVec.x,e.position.y,this._tmpVec.z),this._tmpQuat.copy(this._orientDummy.quaternion),this._tmpEuler.set(e.userData.currentTiltX,e.userData.currentTiltY,0,"XYZ"),this._tmpQuat2.setFromEuler(this._tmpEuler),this._tmpQuat.multiply(this._tmpQuat2),e.quaternion.slerp(this._tmpQuat,.04)}_updateCardGlow(e,r){if(e.userData?.glow?.material){const t=e.userData.glow;t.material.opacity=Math.max(.06,.6*(.5+.5*Math.sin(r*.002+e.userData.id)))*e.userData.entranceProgress}}handleClick(e){const r=e||this._lastPointerPos||{x:0,y:0};if(!this.cardGroup.visible)return;const t=this.getHoveredCardFromScreen(r);if(t){const i=t.userData.link;if(!i||i==="#")return;globalThis.location.href=i}}attachPointerHandlers(e){const r=e||this.renderer?.domElement||globalThis;this._boundPointerMove&&this.detachPointerHandlers(),this._boundPointerMove=t=>{const i=r.getBoundingClientRect?.()??{left:0,top:0,width:globalThis.innerWidth,height:globalThis.innerHeight},a=(t.clientX-i.left)/i.width*2-1,o=-((t.clientY-i.top)/i.height)*2+1;this._lastPointerPos.x=a,this._lastPointerPos.y=o},this._boundPointerDown=t=>{this._pointerDown=!0,this._pointerDownPos={...this._lastPointerPos}},this._boundPointerUp=t=>{if(!this._pointerDown||(this._pointerDown=!1,!this._pointerDownPos))return;const i=this._lastPointerPos.x-this._pointerDownPos.x,a=this._lastPointerPos.y-this._pointerDownPos.y;Math.hypot(i,a)<.04&&this.handleClick(this._lastPointerPos),this._pointerDownPos=null},r.addEventListener("pointermove",this._boundPointerMove),r.addEventListener("pointerdown",this._boundPointerDown),r.addEventListener("pointerup",this._boundPointerUp),this._pointerElement=r}detachPointerHandlers(){const e=this._pointerElement||this.renderer?.domElement||globalThis;e&&(this._boundPointerMove&&e.removeEventListener("pointermove",this._boundPointerMove),this._boundPointerDown&&e.removeEventListener("pointerdown",this._boundPointerDown),this._boundPointerUp&&e.removeEventListener("pointerup",this._boundPointerUp),this._pointerElement=null,this._boundPointerMove=null,this._boundPointerDown=null,this._boundPointerUp=null)}getProfilingData(){return{texturesCreated:this._profile.texturesCreated,texturesDisposed:this._profile.texturesDisposed,cacheHits:this._profile.cacheHits,cacheMisses:this._profile.cacheMisses,cachedTextures:this._textureCache.size}}alignCardsToCameraImmediate(){this.camera&&(this.camera.getWorldPosition(this._tmpVec),this.cards.forEach(e=>{this._orientDummy.position.copy(e.position),this._orientDummy.lookAt(this._tmpVec.x,e.position.y,this._tmpVec.z),e.quaternion.copy(this._orientDummy.quaternion),e.userData.currentTiltX=0,e.userData.currentTiltY=0}))}cleanup(){this.scene.remove(this.cardGroup),this.cards.forEach(e=>this._disposeCardResources(e)),this._sharedGeometry&&(this._sharedGeometry.dispose(),this._sharedGeometry=null),this._sharedGlowTexture?.dispose&&(this._sharedGlowTexture.dispose(),this._sharedGlowTexture=null),this.cards=[],this._disposeCachedTextures();try{this.detachPointerHandlers()}catch{}this._removeResizeHandler()}_disposeCardResources(e){try{e.geometry?.dispose&&e.geometry!==this._sharedGeometry&&e.geometry.dispose(),e.material&&(this._releaseTextureFromCache(e.material.map),e.material.map=null,e.material.dispose?.());const r=e.userData?.glow;r?.material&&this._disposeGlowMaterial(r)}catch(r){_.warn("EarthCards: disposal error",r)}}_disposeCachedTextures(){for(const[,e]of this._textureCache.entries())try{e.texture?.dispose&&(e.texture.dispose(),this._profile.texturesDisposed++)}catch(r){_.warn("EarthCards: error disposing cached texture",r)}this._textureCache.clear()}_releaseTextureFromCache(e){if(e)try{let r=null;for(const[t,i]of this._textureCache.entries())if(i.texture===e){r=t,i.count--,i.count<=0&&(i.texture?.dispose&&(i.texture.dispose(),this._profile.texturesDisposed++),this._textureCache.delete(t));break}!r&&e?.dispose&&e.dispose()}catch(r){_.warn("EarthCards: releaseTextureFromCache failed",r)}}_disposeGlowMaterial(e){try{e.material.map?.dispose&&e.material.map!==this._sharedGlowTexture&&e.material.map.dispose(),e.material.dispose?.()}catch(r){_.warn("EarthCards: glow dispose failed",r)}}_removeResizeHandler(){try{globalThis.removeEventListener("resize",this._onResize)}catch{}this._onResize=null,this._resizeRAF&&(cancelAnimationFrame(this._resizeRAF),this._resizeRAF=null)}_createMeshFromData(e,r,t,i){const a=this.createCardTexture(e),o=new this.THREE.MeshBasicMaterial({map:a,transparent:!0,side:this.THREE.DoubleSide,opacity:0,depthWrite:!1}),l=new this.THREE.Mesh(this._sharedGeometry,o);l.position.set(e.position.x,e.position.y-.8,e.position.z);const n=Math.min(1,(globalThis.innerWidth||1200)/1200);l.scale.setScalar(.95*Math.max(.85,n)),l.userData={isCard:!0,link:e.link,originalY:e.position.y,hoverY:e.position.y+.5,targetOpacity:1,id:e.id,entranceDelay:r*80,entranceProgress:0,hoverProgress:0,parallaxStrength:.14,currentTiltX:0,currentTiltY:0};const h=new this.THREE.SpriteMaterial({map:this._sharedGlowTexture,color:e.color,transparent:!0,blending:this.THREE.AdditiveBlending,depthWrite:!1}),s=new this.THREE.Sprite(h);return s.scale.set(t*.95,i*.45,1),s.position.set(0,-.12,-.01),l.add(s),l.userData.glow=s,l}}export{M as CardManager};
