import{createLogger as v}from"../../../utils/shared-utilities.js";const _=v("CardManager");class M{constructor(t,r,e,i){this.THREE=t,this.scene=r,this.camera=e,this.renderer=i,this.cards=[],this.raycaster=new t.Raycaster,this.isVisible=!1,this._hovered=null,this._hoverCandidate=null,this._hoverFrames=0,this._resizeRAF=null,this._sharedGeometry=null,this._sharedGlowTexture=null,this._tmpVec=new t.Vector3,this._tmpQuat=new t.Quaternion,this._tmpQuat2=new t.Quaternion,this._tmpEuler=new t.Euler,this._orientDummy=new t.Object3D,this.cardGroup=new t.Group,this.scene.add(this.cardGroup),this.cardGroup.visible=!1,this._textureCache=new Map,this._profile={texturesCreated:0,texturesDisposed:0,cacheHits:0,cacheMisses:0},this._lastPointerPos={x:0,y:0},this._pointerDown=!1,this._pointerDownPos=null,this._boundPointerMove=null,this._boundPointerDown=null,this._boundPointerUp=null}_pixelsToWorldY(t){if(!this.renderer||!this.camera)return 0;const r=this.renderer.domElement.getBoundingClientRect().height||(globalThis.window?.innerHeight??800);if(!r)return 0;const e=t/r*2,i=new this.THREE.Vector3(0,0,.5),a=new this.THREE.Vector3(0,-e,.5);return i.unproject(this.camera),a.unproject(this.camera),a.y-i.y}initFromData(t){if(this.cards.length>0||!Array.isArray(t)||t.length===0)return;_.debug(`Initializing ${t.length} cards from data`);const r=t.length,e=2.2,i=2.8,a=e*(r>2?1.4:1.25),o=(r-1)/2;this._baseW=e,this._baseH=i;const l=t.map((n,h)=>({x:(h-o)*a,y:0,z:0,color:n.color||["#07a1ff","#a107ff","#ff07a1"][h]||"#ffffff"}));this._sharedGeometry=new this.THREE.PlaneGeometry(e,i),this._sharedGlowTexture||(this._sharedGlowTexture=this.createGlowTexture()),t.forEach((n,h)=>{const s={id:h,title:n.title||"",subtitle:n.subtitle||"",text:n.text||"",link:n.link||"#",iconChar:n.iconChar||"",color:l[h].color,position:l[h]},c=this._createMeshFromData(s,h,e,i);this.cardGroup.add(c),this.cards.push(c)}),this.isVisible&&(this.cardGroup.visible=!0),this._onResize=()=>{this._resizeRAF&&cancelAnimationFrame(this._resizeRAF),this._resizeRAF=requestAnimationFrame(()=>{const n=window.innerWidth,h=n<768;this.cards.forEach((s,c)=>{if(h){const d=(o-c)*2.9,p=this._pixelsToWorldY(76);s.scale.setScalar(.82),s.position.x=0;const u=d-p;s.position.y=u,s.userData.originalY=u,s.userData.hoverY=u+.2}else{const d=Math.min(1,n/1200),p=e*(r>2?1.4:1.25)*Math.max(.85,d),u=(c-o)*p;s.scale.setScalar(.95*Math.max(.65,d)),s.position.x=u,s.position.y=0,s.userData.originalY=0,s.userData.hoverY=.5}}),this._resizeRAF=null})},globalThis.window!==void 0&&(window.addEventListener("resize",this._onResize),this._onResize())}getCardScreenRects(){if(!this.renderer||!this.camera||this.cards.length===0)return[];const t=this.renderer.domElement.getBoundingClientRect(),r=t.width,e=t.height,i=new this.THREE.Vector3,a=new this.THREE.Vector3;return this.cards.map(o=>{o.updateMatrixWorld(),o.getWorldPosition(i),i.project(this.camera);const l=(i.x*.5+.5)*r+t.left,n=(-i.y*.5+.5)*e+t.top,h=(this._baseW||2.2)*.5*o.scale.x,s=(this._baseH||2.8)*.5*o.scale.y;a.set(h,0,0).applyMatrix4(o.matrixWorld),a.project(this.camera);const c=(a.x*.5+.5)*r+t.left;a.set(0,s,0).applyMatrix4(o.matrixWorld),a.project(this.camera);const d=(-a.y*.5+.5)*e+t.top,p=Math.min(l,c)-Math.abs(c-l),u=Math.max(l,c),x=Math.min(n,d)-Math.abs(d-n),f=Math.max(n,d);return{left:p,top:x,right:u,bottom:f}})}createCardTexture(t){const r=globalThis.window?.devicePixelRatio?globalThis.window.devicePixelRatio:1,e=Math.min(Math.max(Math.ceil(r*2),2),4),i=512*e,a=700*e,o={title:(t.title||"").slice(0,256),subtitle:(t.subtitle||"").slice(0,128),text:(t.text||"").slice(0,512),iconChar:t.iconChar||"",color:t.color||"#ffffff",DPR:Math.round(r*100)},l=JSON.stringify(o),n=this._textureCache.get(l);if(n?.texture)return n.count++,this._profile.cacheHits++,n.texture;this._profile.cacheMisses++;const h=typeof OffscreenCanvas>"u"?document.createElement("canvas"):new OffscreenCanvas(i,a);typeof OffscreenCanvas>"u"&&(h.width=i,h.height=a);const s=h.getContext("2d");if(!s){_.warn("CardManager: 2D canvas context unavailable; returning empty texture");const y=new this.THREE.CanvasTexture(h);return y.needsUpdate=!0,y}const c=s.createLinearGradient(0,0,i,a);c.addColorStop(0,"rgba(20, 30, 60, 0.9)"),c.addColorStop(1,"rgba(10, 15, 30, 0.95)"),s.fillStyle=c;const d=40*e;this.roundRect(s,0,0,i,a,d),s.fill(),this.drawStarBorder(s,0,0,i,a,d,e);const p=150*e,u=256*e,x=60*e;s.fillStyle="rgba(255, 255, 255, 0.05)",s.beginPath(),s.arc(u,p,x,0,Math.PI*2),s.fill(),s.strokeStyle=t.color,s.lineWidth=2*e,s.stroke(),s.fillStyle="#ffffff",s.font=`${60*e}px "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", Arial, sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(t.iconChar,u,p+5*e),s.fillStyle=t.color;const f=(t.subtitle||"").trim(),T=this.fitTextToWidth(s,f,420*e,"bold",24*e,12*e,'Arial, "Helvetica Neue", sans-serif');s.font=`bold ${T}px Arial, "Helvetica Neue", sans-serif`,s.fillText(f,u,280*e),s.fillStyle="#ffffff";const g=(t.title||"").trim(),w=this.fitTextToWidth(s,g,420*e,"bold",48*e,20*e,'Arial, "Helvetica Neue", sans-serif');s.font=`bold ${w}px Arial, "Helvetica Neue", sans-serif`,s.fillText(g,u,350*e),s.fillStyle="#cccccc";const b=t.text&&t.text.length>160?Math.max(18*e,22*e):30*e;s.font=`${b}px Arial, "Helvetica Neue", sans-serif`,this.wrapText(s,t.text,u,450*e,400*e,Math.round(40*e));const m=new this.THREE.CanvasTexture(h);return m.generateMipmaps=!0,m.minFilter=this.THREE.LinearMipmapLinearFilter,m.magFilter=this.THREE.LinearFilter,m.anisotropy=this.renderer?.capabilities?.getMaxAnisotropy?.()??0,m.needsUpdate=!0,this._textureCache.set(l,{texture:m,count:1}),this._profile.texturesCreated++,m}createGlowTexture(){const t=globalThis.devicePixelRatio?Math.min(globalThis.devicePixelRatio,2):1,r=Math.floor(128*t),e=typeof OffscreenCanvas>"u"?document.createElement("canvas"):new OffscreenCanvas(r,r);typeof OffscreenCanvas>"u"&&(e.width=r,e.height=r);const i=e.getContext("2d");if(!i){_.warn("CardManager: 2D canvas context unavailable for glow; returning empty texture");const s=new this.THREE.CanvasTexture(e);return s.needsUpdate=!0,s}const a=r/2,o=r/2,l=r*.45,n=i.createRadialGradient(a,o,l*.1,a,o,l);n.addColorStop(0,"rgba(255,255,255,0.9)"),n.addColorStop(.3,"rgba(255,255,255,0.45)"),n.addColorStop(1,"rgba(255,255,255,0)"),i.fillStyle=n,i.beginPath(),i.arc(a,o,l,0,Math.PI*2),i.fill();const h=new this.THREE.CanvasTexture(e);return h.generateMipmaps=!0,h.minFilter=this.THREE.LinearMipmapLinearFilter,h.magFilter=this.THREE.LinearFilter,h.needsUpdate=!0,h}roundRect(t,r,e,i,a,o){i<2*o&&(o=i/2),a<2*o&&(o=a/2),t.beginPath(),t.moveTo(r+o,e),t.arcTo(r+i,e,r+i,e+a,o),t.arcTo(r+i,e+a,r,e+a,o),t.arcTo(r,e+a,r,e,o),t.arcTo(r,e,r+i,e,o),t.closePath()}drawStarBorder(t,r,e,i,a,o,l){t.strokeStyle="rgba(255, 255, 255, 0.15)",t.lineWidth=1.5,this.roundRect(t,r,e,i,a,o),t.stroke();const n=Math.min(200,Math.max(20,Math.floor(60*l)));t.save();for(let h=0;h<n;h++){const s=Math.floor(Math.random()*4);let c,d;s===0?(c=r+Math.random()*i,d=e):s===1?(c=r+i,d=e+Math.random()*a):s===2?(c=r+Math.random()*i,d=e+a):(c=r,d=e+Math.random()*a);const p=Math.random()*1.5+.5;t.fillStyle=Math.random()>.7?t.strokeStyle:"#ffffff",t.globalAlpha=Math.random()*.8+.2,t.beginPath(),t.arc(c,d,p,0,Math.PI*2),t.fill()}t.restore()}wrapText(t,r,e,i,a,o){const l=(r||"").split(" ");let n="",h=0;const s=4;for(let c=0;c<l.length;c++){const d=n+l[c]+" ";if(t.measureText(d).width>a&&c>0){if(t.fillText(n,e,i),n=l[c]+" ",i+=o,h++,h>=s){n+="...";break}}else n=d}t.fillText(n,e,i)}fitTextToWidth(t,r,e,i="normal",a=24,o=12,l="Arial, sans-serif"){if(!r)return a;let n=a;for(t.textAlign="center",t.textBaseline="middle";n>=o&&(t.font=`${i} ${Math.round(n)}px ${l}`,!(t.measureText(r).width<=e));)n-=1;return Math.max(o,Math.round(n))}setVisible(t){this.isVisible=t,this.setProgress(t?1:0)}setProgress(t){const r=Math.max(0,Math.min(1,typeof t=="number"&&!Number.isNaN(t)?t:0)),e=this.cardGroup.visible;this.cardGroup.visible=r>.01,this.cardGroup.visible&&!e&&this.alignCardsToCameraImmediate(),this.cards.forEach(i=>{const a=(i.userData.entranceDelay||0)/800,o=Math.max(0,Math.min(1,(r-a)/Math.max(1e-4,1-a)));i.userData.entranceTarget=o,i.userData.targetOpacity=o>0?1:0})}getHoveredCardFromScreen(t){if(!this.raycaster||!this.camera)return null;this.raycaster.setFromCamera(t,this.camera);const r=this.raycaster.intersectObjects(this.cards,!1);return r.length>0?r[0].object:null}update(t,r){if(!this.cardGroup.visible)return;const e=r||this._lastPointerPos||{x:0,y:0},i=this.getHoveredCardFromScreen(e);i===this._hoverCandidate?(this._hoverFrames++,this._hoverFrames>=3&&i!==this._hovered&&(this._hovered=i,document.body.style.cursor=i?"pointer":"")):(this._hoverCandidate=i,this._hoverFrames=0);const a=this._hovered;this.camera.getWorldPosition(this._tmpVec),this.cards.forEach(o=>{this._updateCardEntranceAndOpacity(o),this._updateCardHoverTiltAndMotion(o,e,a,t),this._applyOrientation(o),this._updateCardGlow(o,t)}),!this.isVisible&&this.cards[0]&&this.cards[0].material.opacity<.01&&(this.cardGroup.visible=!1)}_updateCardEntranceAndOpacity(t){let r;typeof t.userData.entranceTarget=="number"?r=t.userData.entranceTarget:r=this.isVisible?1:0,t.userData.entranceProgress+=(r-t.userData.entranceProgress)*.02;const e=t.userData.targetOpacity||1;t.material.opacity=e*(.05+.95*t.userData.entranceProgress)}_updateCardHoverTiltAndMotion(t,r,e,i){const a=Math.sin(i*.001+t.userData.id)*.06*(1-t.userData.hoverProgress*.7),o=t===e;let l=o?1:0;!o&&t.userData.hoverProgress>.5&&(l=t.userData.hoverProgress),t.userData.hoverProgress+=(l-t.userData.hoverProgress)*.04;const n=t.userData.parallaxStrength||.12,h=-r.y*n*t.userData.hoverProgress,s=r.x*n*t.userData.hoverProgress*.8;t.userData.currentTiltX+=(h-t.userData.currentTiltX)*.04,t.userData.currentTiltY+=(s-t.userData.currentTiltY)*.04;let c=t.userData.originalY,d=1;t===e&&(c=t.userData.hoverY,d=1.05),t.position.y+=(c+a-t.position.y)*.04,t.scale.setScalar(t.scale.x+(d-t.scale.x)*.04)}_applyOrientation(t){this._orientDummy.position.copy(t.position),this._orientDummy.lookAt(this._tmpVec.x,t.position.y,this._tmpVec.z),this._tmpQuat.copy(this._orientDummy.quaternion),this._tmpEuler.set(t.userData.currentTiltX,t.userData.currentTiltY,0,"XYZ"),this._tmpQuat2.setFromEuler(this._tmpEuler),this._tmpQuat.multiply(this._tmpQuat2),t.quaternion.slerp(this._tmpQuat,.04)}_updateCardGlow(t,r){if(t.userData?.glow?.material){const e=t.userData.glow;e.material.opacity=Math.max(.06,.6*(.5+.5*Math.sin(r*.002+t.userData.id)))*t.userData.entranceProgress}}handleClick(t){const r=t||this._lastPointerPos||{x:0,y:0};if(!this.cardGroup.visible)return;const e=this.getHoveredCardFromScreen(r);if(e){const i=e.userData.link;if(!i||i==="#")return;globalThis.location.href=i}}attachPointerHandlers(t){const r=t||this.renderer?.domElement||globalThis;this._boundPointerMove&&this.detachPointerHandlers(),this._boundPointerMove=e=>{const i=r.getBoundingClientRect?.()??{left:0,top:0,width:globalThis.innerWidth,height:globalThis.innerHeight},a=(e.clientX-i.left)/i.width*2-1,o=-((e.clientY-i.top)/i.height)*2+1;this._lastPointerPos.x=a,this._lastPointerPos.y=o},this._boundPointerDown=e=>{this._pointerDown=!0,this._pointerDownPos={...this._lastPointerPos}},this._boundPointerUp=e=>{if(!this._pointerDown||(this._pointerDown=!1,!this._pointerDownPos))return;const i=this._lastPointerPos.x-this._pointerDownPos.x,a=this._lastPointerPos.y-this._pointerDownPos.y;Math.hypot(i,a)<.04&&this.handleClick(this._lastPointerPos),this._pointerDownPos=null},r.addEventListener("pointermove",this._boundPointerMove),r.addEventListener("pointerdown",this._boundPointerDown),r.addEventListener("pointerup",this._boundPointerUp),this._pointerElement=r}detachPointerHandlers(){const t=this._pointerElement||this.renderer?.domElement||globalThis;t&&(this._boundPointerMove&&t.removeEventListener("pointermove",this._boundPointerMove),this._boundPointerDown&&t.removeEventListener("pointerdown",this._boundPointerDown),this._boundPointerUp&&t.removeEventListener("pointerup",this._boundPointerUp),this._pointerElement=null,this._boundPointerMove=null,this._boundPointerDown=null,this._boundPointerUp=null)}getProfilingData(){return{texturesCreated:this._profile.texturesCreated,texturesDisposed:this._profile.texturesDisposed,cacheHits:this._profile.cacheHits,cacheMisses:this._profile.cacheMisses,cachedTextures:this._textureCache.size}}alignCardsToCameraImmediate(){this.camera&&(this.camera.getWorldPosition(this._tmpVec),this.cards.forEach(t=>{this._orientDummy.position.copy(t.position),this._orientDummy.lookAt(this._tmpVec.x,t.position.y,this._tmpVec.z),t.quaternion.copy(this._orientDummy.quaternion),t.userData.currentTiltX=0,t.userData.currentTiltY=0}))}cleanup(){this.scene.remove(this.cardGroup),this.cards.forEach(t=>this._disposeCardResources(t)),this._sharedGeometry&&(this._sharedGeometry.dispose(),this._sharedGeometry=null),this._sharedGlowTexture?.dispose&&(this._sharedGlowTexture.dispose(),this._sharedGlowTexture=null),this.cards=[],this._disposeCachedTextures();try{this.detachPointerHandlers()}catch{}this._removeResizeHandler()}_disposeCardResources(t){try{t.geometry?.dispose&&t.geometry!==this._sharedGeometry&&t.geometry.dispose(),t.material&&(this._releaseTextureFromCache(t.material.map),t.material.map=null,t.material.dispose?.());const r=t.userData?.glow;r?.material&&this._disposeGlowMaterial(r)}catch(r){_.warn("EarthCards: disposal error",r)}}_disposeCachedTextures(){for(const[,t]of this._textureCache.entries())try{t.texture?.dispose&&(t.texture.dispose(),this._profile.texturesDisposed++)}catch(r){_.warn("EarthCards: error disposing cached texture",r)}this._textureCache.clear()}_releaseTextureFromCache(t){if(t)try{let r=null;for(const[e,i]of this._textureCache.entries())if(i.texture===t){r=e,i.count--,i.count<=0&&(i.texture?.dispose&&(i.texture.dispose(),this._profile.texturesDisposed++),this._textureCache.delete(e));break}!r&&t?.dispose&&t.dispose()}catch(r){_.warn("EarthCards: releaseTextureFromCache failed",r)}}_disposeGlowMaterial(t){try{t.material.map?.dispose&&t.material.map!==this._sharedGlowTexture&&t.material.map.dispose(),t.material.dispose?.()}catch(r){_.warn("EarthCards: glow dispose failed",r)}}_removeResizeHandler(){try{globalThis.removeEventListener("resize",this._onResize)}catch{}this._onResize=null,this._resizeRAF&&(cancelAnimationFrame(this._resizeRAF),this._resizeRAF=null)}_createMeshFromData(t,r,e,i){const a=this.createCardTexture(t),o=new this.THREE.MeshBasicMaterial({map:a,transparent:!0,side:this.THREE.DoubleSide,opacity:0,depthWrite:!1}),l=new this.THREE.Mesh(this._sharedGeometry,o);l.position.set(t.position.x,t.position.y-.8,t.position.z);const n=Math.min(1,(globalThis.innerWidth||1200)/1200);l.scale.setScalar(.95*Math.max(.85,n)),l.userData={isCard:!0,link:t.link,originalY:t.position.y,hoverY:t.position.y+.5,targetOpacity:1,id:t.id,entranceDelay:r*80,entranceProgress:0,hoverProgress:0,parallaxStrength:.14,currentTiltX:0,currentTiltY:0};const h=new this.THREE.SpriteMaterial({map:this._sharedGlowTexture,color:t.color,transparent:!0,blending:this.THREE.AdditiveBlending,depthWrite:!1}),s=new this.THREE.Sprite(h);return s.scale.set(e*.95,i*.45,1),s.position.set(0,-.12,-.01),l.add(s),l.userData.glow=s,l}}export{M as CardManager};
