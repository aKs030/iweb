import{CONFIG as o}from"./config.js";import{createLogger as R}from"../../../utils/shared-utilities.js";const w=R("EarthStars");class C{constructor(t,i,e,s){this.THREE=t,this.scene=i,this.camera=e,this.renderer=s,this.starField=null,this.isDisposed=!1,this.transition={active:!1,startTime:0,duration:o.STARS.ANIMATION.DURATION,startValue:0,targetValue:0,rafId:null},this.isMobileDevice=window.matchMedia("(max-width: 768px)").matches,this.scrollUpdateEnabled=!1,this.lastScrollUpdate=0,this.scrollUpdateThrottle=150,this.boundScrollHandler=null,this.areStarsFormingCards=!1,this.tempVector=new this.THREE.Vector3}createStarField(){if(this.isDisposed)return null;const t=this.isMobileDevice?o.STARS.COUNT/2:o.STARS.COUNT,i=new Float32Array(t*3),e=new Float32Array(t*3),s=new Float32Array(t*3),r=new Float32Array(t),a=new this.THREE.Color;for(let u=0;u<t;u++){const h=u*3,g=100+Math.random()*200,f=Math.random()*Math.PI*2,c=Math.acos(2*Math.random()-1),l=g*Math.sin(c)*Math.cos(f),d=g*Math.sin(c)*Math.sin(f),m=g*Math.cos(c);i[h]=l,i[h+1]=d,i[h+2]=m,e[h]=l,e[h+1]=d,e[h+2]=m,a.setHSL(Math.random()*.1+.5,.8,.8+Math.random()*.2),s[h]=a.r,s[h+1]=a.g,s[h+2]=a.b,r[u]=Math.random()*1.5+.5}const n=new this.THREE.BufferGeometry;n.setAttribute("position",new this.THREE.BufferAttribute(i,3)),n.setAttribute("aTargetPosition",new this.THREE.BufferAttribute(e,3)),n.setAttribute("color",new this.THREE.BufferAttribute(s,3)),n.setAttribute("size",new this.THREE.BufferAttribute(r,1));const p=new this.THREE.ShaderMaterial({uniforms:{time:{value:0},twinkleSpeed:{value:o.STARS.TWINKLE_SPEED},uTransition:{value:0}},vertexShader:`
        attribute float size;
        attribute vec3 aTargetPosition;
        uniform float uTransition;
        varying vec3 vColor;

        void main() {
          vColor = color;
          vec3 currentPos = mix(position, aTargetPosition, uTransition);
          vec4 mvPosition = modelViewMatrix * vec4(currentPos, 1.0);
          gl_PointSize = size * (300.0 / -mvPosition.z);
          gl_Position = projectionMatrix * mvPosition;
        }
      `,fragmentShader:`
        uniform float time;
        uniform float twinkleSpeed;
        varying vec3 vColor;
        void main() {
          float strength = (sin(time * twinkleSpeed + gl_FragCoord.x * 0.5) + 1.0) / 2.0 * 0.5 + 0.5;
          gl_FragColor = vec4(vColor, strength);
        }
      `,blending:this.THREE.AdditiveBlending,depthWrite:!1,transparent:!0,vertexColors:!0});return this.starField=new this.THREE.Points(n,p),this.scene.add(this.starField),this.starField}handleResize(t,i){if(this.areStarsFormingCards&&!this.transition.active){const e=this.getCardPositions();e.length>0&&this.updateTargetBuffer(e)}}setCardManager(t){this.cardManager=t}getCardPositions(){if(!this.camera||this.isDisposed)return[];if(this.cardManager?.getCardScreenRects){const t=this.cardManager.getCardScreenRects();if(!t||t.length===0)return[];const i=[],e=this.renderer?this.renderer.domElement.clientWidth:window.innerWidth,s=this.renderer?this.renderer.domElement.clientHeight:window.innerHeight;return t.forEach(r=>{if(r.right-r.left>0&&r.bottom-r.top>0){const a=this.getCardPerimeterPositions(r,e,s,-2,t.length);i.push(...a)}}),i}return[]}getCardPerimeterPositions(t,i,e,s,r=3){const a=[],n=this.isMobileDevice?o.STARS.COUNT/2:o.STARS.COUNT,p=Math.floor(n/r),u=Math.floor(p*.2),h=p-u,g=Math.floor(u/4),f=(l,d)=>{const m=l/i*2-1,T=-(d/e*2-1);this.tempVector.set(m,T,0),this.tempVector.unproject(this.camera),this.tempVector.sub(this.camera.position).normalize();const S=(s-this.camera.position.z)/this.tempVector.z,E=this.camera.position.x+this.tempVector.x*S,M=this.camera.position.y+this.tempVector.y*S,v=this.camera.position.z+this.tempVector.z*S;return{x:E,y:M,z:v}},c=(l,d,m,T)=>{for(let S=0;S<g;S++){const E=S/Math.max(1,g-1),M=l+(m-l)*E,v=d+(T-d)*E,b=f(M,v);a.push(b)}};c(t.left,t.top,t.right,t.top),c(t.right,t.top,t.right,t.bottom),c(t.right,t.bottom,t.left,t.bottom),c(t.left,t.bottom,t.left,t.top);for(let l=0;l<h;l++){const d=t.left+Math.random()*t.width,m=t.top+Math.random()*t.height,T=f(d,m);a.push(T)}return a}animateStarsToCards(){if(!this.starField||this.isDisposed)return;this.areStarsFormingCards=!0;const t=this.getCardPositions();t.length!==0&&(this.updateTargetBuffer(t),this.startTransition(1),this.enableScrollUpdates(),setTimeout(()=>{if(!this.isDisposed&&this.transition.targetValue===1){const i=this.getCardPositions();i.length>0&&this.updateTargetBuffer(i)}},o.STARS.ANIMATION.CAMERA_SETTLE_DELAY))}resetStarsToOriginal(){!this.starField||this.isDisposed||(this.areStarsFormingCards=!1,this.disableScrollUpdates(),this.startTransition(0))}enableScrollUpdates(){this.scrollUpdateEnabled||this.isDisposed||(this.scrollUpdateEnabled=!0,this.boundScrollHandler=this.handleScroll.bind(this),window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}))}disableScrollUpdates(){this.scrollUpdateEnabled&&(this.scrollUpdateEnabled=!1,this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null))}handleScroll(){if(!this.scrollUpdateEnabled||this.isDisposed||this.transition.active)return;const t=performance.now();if(t-this.lastScrollUpdate<this.scrollUpdateThrottle)return;this.lastScrollUpdate=t;const i=this.getCardPositions();i.length>0&&this.updateTargetBuffer(i)}updateTargetBuffer(t){if(this.isDisposed||!this.starField)return;const i=this.starField.geometry.attributes.aTargetPosition,e=i.array,s=e.length/3;for(let r=0;r<s;r++){const a=r*3,n=t[r%t.length];if(n){const p=o.STARS.ANIMATION.SPREAD_XY;e[a]=n.x+(Math.random()-.5)*p,e[a+1]=n.y+(Math.random()-.5)*p,e[a+2]=n.z+(Math.random()-.5)*o.STARS.ANIMATION.SPREAD_Z}}i.needsUpdate=!0}startTransition(t){if(this.isDisposed)return;const i=this.starField.material.uniforms.uTransition.value;Math.abs(i-t)<.01||(this.transition.active=!0,this.transition.startTime=performance.now(),this.transition.startValue=i,this.transition.targetValue=t,this.transition.rafId&&cancelAnimationFrame(this.transition.rafId),this.animateTransitionLoop())}animateTransitionLoop(){if(!this.transition.active||this.isDisposed)return;const t=performance.now()-this.transition.startTime,i=Math.min(t/this.transition.duration,1);i>=1&&(this.transition.active=!1);const e=this.easeInOutCubic(i);if(this.starField&&this.starField.material){const s=this.transition.startValue+(this.transition.targetValue-this.transition.startValue)*e;this.starField.material.uniforms.uTransition.value=s,this.updateCardOpacity(s)}this.transition.active&&(this.transition.rafId=requestAnimationFrame(()=>this.animateTransitionLoop()))}updateCardOpacity(t){this.cardManager&&typeof this.cardManager.setProgress=="function"&&this.cardManager.setProgress(t)}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}update(t){this.starField&&!this.isDisposed&&(this.starField.material.uniforms.time.value=t)}cleanup(){this.isDisposed=!0,this.disableScrollUpdates(),this.transition.active=!1,this.areStarsFormingCards=!1,this.transition.rafId&&(cancelAnimationFrame(this.transition.rafId),this.transition.rafId=null),this.starField&&(this.scene&&this.scene.remove(this.starField),this.starField.geometry&&this.starField.geometry.dispose(),this.starField.material&&this.starField.material.dispose(),this.starField=null)}}class F{constructor(t,i){this.scene=t,this.THREE=i,this.activeStars=[],this.pool=[],this.isShowerActive=!1,this.showerTimer=0,this.showerCooldownTimer=0,this.disabled=!1,this.isDisposed=!1,this.sharedGeometry=new this.THREE.SphereGeometry(.05,8,8),this.sharedMaterial=new this.THREE.MeshBasicMaterial({color:16776687,transparent:!0,opacity:1})}createShootingStar(){if(!(this.isDisposed||this.activeStars.length>=o.SHOOTING_STARS.MAX_SIMULTANEOUS))try{let t;if(this.pool.length>0)t=this.pool.pop(),t.material.opacity=1,t.visible=!0;else{const s=this.sharedMaterial.clone();t=new this.THREE.Mesh(this.sharedGeometry,s)}const i={x:(Math.random()-.5)*100,y:20+Math.random()*20,z:-50-Math.random()*50},e=new this.THREE.Vector3((Math.random()-.9)*.2,(Math.random()-.6)*-.2,0);t.position.set(i.x,i.y,i.z),t.scale.set(1,1,2+Math.random()*3),t.lookAt(t.position.clone().add(e)),this.activeStars.push({mesh:t,velocity:e,lifetime:300+Math.random()*200,age:0}),this.scene.add(t)}catch(t){w.error("Failed to create shooting star:",t)}}update(){if(this.disabled||this.isDisposed)return;this.isShowerActive&&(this.showerTimer++,this.showerTimer>=o.SHOOTING_STARS.SHOWER_DURATION&&(this.isShowerActive=!1,this.showerCooldownTimer=o.SHOOTING_STARS.SHOWER_COOLDOWN)),this.showerCooldownTimer>0&&this.showerCooldownTimer--;const t=this.isShowerActive?o.SHOOTING_STARS.SHOWER_FREQUENCY:o.SHOOTING_STARS.BASE_FREQUENCY;Math.random()<t&&this.createShootingStar();for(let i=this.activeStars.length-1;i>=0;i--){const e=this.activeStars[i];e.age++,e.mesh.position.add(e.velocity);const s=e.lifetime*.7;if(e.age>s){const r=(e.age-s)/(e.lifetime-s);e.mesh.material.opacity=1-r}e.age>e.lifetime&&(this.scene.remove(e.mesh),this.pool.push(e.mesh),this.activeStars.splice(i,1))}}triggerShower(){this.isDisposed||this.isShowerActive||this.showerCooldownTimer>0||(this.isShowerActive=!0,this.showerTimer=0,w.info("\u{1F320} Meteor shower triggered!"))}cleanup(){this.isDisposed=!0,this.activeStars.forEach(t=>{this.scene.remove(t.mesh),t.mesh.material&&t.mesh.material.dispose()}),this.activeStars=[],this.pool.forEach(t=>{t.material&&t.material.dispose()}),this.pool=[],this.sharedGeometry&&this.sharedGeometry.dispose(),this.sharedMaterial&&this.sharedMaterial.dispose()}}export{F as ShootingStarManager,C as StarManager};
