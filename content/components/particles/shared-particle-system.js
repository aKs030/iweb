import{createLogger as p,throttle as y}from"../../utils/shared-utilities.js";import{THREE_PATHS as l}from"./config.js";const t=p("sharedParticleSystem"),u={PERFORMANCE:{THROTTLE_MS:20},SCROLL:{CSS_PROPERTY_PREFIX:"--scroll-"}};class w{constructor(){this.systems=new Map,this.isInitialized=!1}registerSystem(e,r){this.systems.has(e)&&t.warn(`System '${e}' already registered, overwriting`),this.systems.set(e,r),t.debug(`System '${e}' registered`)}unregisterSystem(e){const r=this.systems.delete(e);return r&&t.debug(`System '${e}' unregistered`),r}hasSystem(e){return this.systems.has(e)}reset(){this.systems.clear(),this.isInitialized=!1,t.debug("State reset")}}const c=new w;class E{constructor(){this.isActive=!1,this.handlers=new Set,this.scrollHandler=null}addHandler(e,r="anonymous"){if(typeof e!="function"){t.error(`Invalid handler for '${r}', must be a function`);return}this.handlers.add({handler:e,name:r}),t.debug(`Parallax handler '${r}' added`),this.isActive||this.activate()}removeHandler(e){const r=Array.from(this.handlers).find(s=>s.handler===e);r&&(this.handlers.delete(r),t.debug(`Parallax handler '${r.name}' removed`)),this.handlers.size===0&&this.deactivate()}activate(){this.isActive||(this.scrollHandler=y(()=>{const e=window.pageYOffset,r=window.innerHeight,s=document.documentElement.scrollHeight,n=Math.max(1,s-r),o=Math.min(1,Math.max(0,e/n));document.documentElement.style.setProperty(`${u.SCROLL.CSS_PROPERTY_PREFIX}progress`,o.toFixed(4)),this.handlers.forEach(({handler:d,name:h})=>{try{d(o)}catch(g){t.error(`Error in parallax handler '${h}':`,g)}})},u.PERFORMANCE.THROTTLE_MS),window.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.isActive=!0,this.scrollHandler(),t.info("Parallax manager activated"))}deactivate(){this.isActive&&(this.scrollHandler&&(window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.isActive=!1,this.handlers.clear(),t.info("Parallax manager deactivated"))}}class S{constructor(){this.cleanupFunctions=new Map}addCleanupFunction(e,r,s="anonymous"){if(typeof r!="function"){t.error(`Invalid cleanup function for '${e}', must be a function`);return}this.cleanupFunctions.has(e)||this.cleanupFunctions.set(e,[]),this.cleanupFunctions.get(e).push({fn:r,description:s}),t.debug(`Cleanup function '${s}' registered for '${e}'`)}cleanupSystem(e){const r=this.cleanupFunctions.get(e);if(!r||r.length===0){t.debug(`No cleanup functions for system '${e}'`);return}t.info(`Cleaning up system '${e}' (${r.length} functions)`);let s=0,n=0;r.forEach(({fn:o,description:d})=>{try{o(),s++}catch(h){n++,t.error(`Error in cleanup '${d}' for '${e}':`,h)}}),this.cleanupFunctions.delete(e),t.info(`System '${e}' cleanup complete: ${s} success, ${n} errors`)}cleanupAll(){t.info("Starting global cleanup of all systems"),Array.from(this.cleanupFunctions.keys()).forEach(e=>this.cleanupSystem(e)),f.deactivate(),c.reset(),t.info("Global cleanup completed")}hasSystem(e){return this.cleanupFunctions.has(e)}getSystemCount(){return this.cleanupFunctions.size}}const f=new E,m=new S;let i=null;async function $(){if(window.THREE?.WebGLRenderer)return t.info("\u2705 Three.js already loaded (cached)"),window.THREE;if(i)return t.debug("Three.js load already in progress, waiting..."),i;i=(async()=>{for(let a=0;a<l.length;a++){const e=l[a];try{if(t.info(`\u{1F4E6} Preparing to load Three.js from: ${e}`),e.startsWith("/")||e.startsWith(location.origin))try{const n=await fetch(e,{method:"HEAD",cache:"no-store"});if(!n.ok){if(t.warn(`HEAD check for local Three.js returned ${n.status} - skipping ${e}`),a===l.length-1)throw t.error("\u274C Local Three.js missing and no further fallbacks"),new Error("Local Three.js not available");continue}const o=n.headers.get("content-encoding");o?t.info(`Server serves precompressed Three.js at ${e} with Content-Encoding: ${o}`):t.info(`No Content-Encoding header for ${e}; server may serve uncompressed or use static precompressed mapping.`)}catch(n){t.debug("HEAD check failed for local Three.js; will attempt import and fallback if needed",n)}else try{const n=await fetch(e,{method:"HEAD",mode:"cors",cache:"no-store"});if(n&&n.ok){const o=n.headers.get("content-encoding");o&&t.info(`Remote precompressed Content-Encoding for ${e}: ${o}`)}}catch(n){t.debug("HEAD check for cross-origin resource failed or blocked by CORS; proceeding to import",n)}t.info(`\u{1F4E6} Loading Three.js from: ${e}`);const r=await import(e),s=r.default||r;if(!s?.WebGLRenderer)throw new Error("Invalid Three.js module - missing WebGLRenderer");return window.THREE=s,t.info("\u2705 Three.js loaded successfully"),s}catch(r){if(t.warn(`Failed to load Three.js from ${e}:`,r.message),a===l.length-1)throw t.error("\u274C Failed to load Three.js from all sources"),new Error("Three.js could not be loaded from any source")}}})();try{return await i}finally{i=null}}function v(){return c}function T(a,e){c.registerSystem(a,e)}function b(a){return c.unregisterSystem(a)}typeof window<"u"&&window.addEventListener("beforeunload",()=>{m.cleanupAll()});export{v as getSharedState,$ as loadThreeJS,T as registerParticleSystem,m as sharedCleanupManager,f as sharedParallaxManager,b as unregisterParticleSystem};
