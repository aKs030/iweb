import{createLogger as E,getElementById as w,shuffle as v,TimerManager as C}from"../../utils/shared-utilities.js";const y=E("TypeWriter");let g=null;function q(){return g}function b(){if(!g)return!1;try{g.destroy()}catch{}return g=null,!0}const _=(h,t)=>Object.entries(t).forEach(([i,r])=>h.style.setProperty(i,r));function S(h){const t=document.createElement("div");t.style.cssText="position:absolute;left:-9999px;top:0;visibility:hidden;white-space:normal;pointer-events:none",document.body.appendChild(t);const i=getComputedStyle(h);["font-size","line-height","font-family","font-weight","letter-spacing","word-spacing","font-kerning","font-variant-ligatures","text-transform","text-rendering","word-break","overflow-wrap","hyphens"].forEach(s=>t.style.setProperty(s,i.getPropertyValue(s)));const r=()=>{const s=i.lineHeight.trim();if(s.endsWith("px")){const n=parseFloat(s);if(!isNaN(n))return n}const o=parseFloat(s);if(!isNaN(o)){const n=parseFloat(i.fontSize);if(!isNaN(n))return o*n}return t.innerHTML='<span style="display:inline-block">A</span>',t.firstChild.getBoundingClientRect().height||0},l=s=>{t.innerHTML="";const o=document.createElement("span");o.textContent=s,t.appendChild(o);const n=h.getBoundingClientRect(),e=Math.max(1,Math.min(Math.max(0,window.innerWidth-(n.left||0)-12)||Math.min(window.innerWidth*.92,820),Math.min(window.innerWidth*.92,820)));t.style.width=e+"px";const a=r(),c=o.getBoundingClientRect().height;if(!a||!c)return 1;const u=parseInt(i.getPropertyValue("--reserve-lines"))||6;return Math.max(1,Math.min(u,Math.round(c/a)))},p=s=>{t.innerHTML="";const o=s.split(" "),n=[];let e=[];const a=h.getBoundingClientRect(),c=Math.max(0,window.innerWidth-(a.left||0)-12),u=Math.min(window.innerWidth*.92,820),x=Math.max(1,Math.min(c||u,u));t.style.width=x+"px";const f=r();return f?(o.forEach(d=>{const m=e.length?e.join(" ")+" "+d:d;t.textContent=m,t.getBoundingClientRect().height>f*1.1?e.length?(n.push(e.join(" ")),e=[d]):(n.push(d),e=[]):e.push(d)}),e.length&&n.push(e.join(" ")),n.length?n:[s]):[s]};return{getLines:p,reserveFor(s){const o=r(),n=p(s).length;return _(h,{"--lh-px":o?`${o}px`:"0px","--gap-px":o?`${o*.25}px`:"0px","--lines":String(n)}),h.setAttribute("data-lines",String(n)),n}}}class M{constructor({textEl:t,authorEl:i,quotes:r,wait:l=2400,typeSpeed:p=85,deleteSpeed:s=40,shuffle:o=!0,loop:n=!0,onBeforeType:e=null}){if(!t||!i||!r?.length){y.error("TypeWriter: Missing required parameters");return}if(this.quotes=r.filter(a=>a?.text),!this.quotes.length)return y.error("No valid quotes");if(Object.assign(this,{textEl:t,authorEl:i,wait:l,typeSpeed:p,deleteSpeed:s,shuffle:o,loop:n,onBeforeType:e,timerManager:new C,_isDeleting:!1,_txt:""}),this._queue=this._createQueue(),this._index=this._queue.shift(),this._current=this.quotes[this._index],document.body.classList.add("has-typingjs"),this.onBeforeType){const a=this.onBeforeType(this._current.text);typeof a=="string"&&(this._current.text=a)}this._tick()}destroy(){this.timerManager.clearAll(),document.body.classList.remove("has-typingjs");try{g===this&&(g=null)}catch{}}_createQueue(){return this.shuffle?v([...Array(this.quotes.length).keys()]):[...Array(this.quotes.length).keys()]}_nextQuote(){if(!this._queue.length){if(!this.loop)return null;this._queue=this._generateQueue(this._index)}return this._index=this._queue.shift(),this._current=this.quotes[this._index]}_generateQueue(t){return this.quotes.length<=1?[0]:this._createQueue()}_renderText(t){if(!this.textEl)return;const i=t.includes(`
`)?t.split(`
`):[t];this.textEl.innerHTML="",i.forEach(r=>{const l=document.createElement("span");l.textContent=r,l.className="typed-line",this.textEl.appendChild(l)})}_tick(){if(!this._current?.text)return this._handleQuoteTransition();const t=String(this._current.text),i=String(this._current.author||"");this._txt=this._isDeleting?t.substring(0,Math.max(0,this._txt.length-1)):t.substring(0,this._txt.length+1),this._renderText(this._txt),this.authorEl&&(this.authorEl.textContent=i);let r=this._isDeleting?this.deleteSpeed:this.typeSpeed;if(!this._isDeleting&&this._txt.length&&(r+={",":120,".":300,"\u2026":400,"!":250,"?":250,";":180,":":180,"\u2014":220,"\u2013":180}[this._txt.slice(-1)]||0),!this._isDeleting&&this._txt===t){try{document.dispatchEvent(new CustomEvent("hero:typingEnd",{detail:{text:t,author:i}}))}catch(l){y.warn("TypeWriter: dispatch hero:typingEnd failed",l)}r=this.wait,this._isDeleting=!0}else if(this._isDeleting&&!this._txt&&(r=this._handleQuoteTransition(),r===null))return;this.timerManager.setTimeout(()=>this._tick(),r)}_handleQuoteTransition(){this._isDeleting=!1;const t=this._nextQuote();if(!t)return this.destroy(),null;if(this.onBeforeType){const i=this.onBeforeType(t.text);typeof i=="string"&&(t.text=i)}return 600}}async function L(h={}){try{const t=document.querySelector(".typewriter-title"),i=w("typedText"),r=w("typedAuthor");if(!t||!i||!r)return!1;const{default:l}=await import("./TypeWriterText.js");if(!l?.length)return!1;let p={};if(h.heroDataModule?.typewriterConfig)p=h.heroDataModule.typewriterConfig;else if(h.ensureHeroDataModule)try{p=(await h.ensureHeroDataModule())?.typewriterConfig||{}}catch(e){y.warn("TypeWriter: ensureHeroDataModule failed",e)}const s=S(t),o=e=>{try{e.style.removeProperty("bottom");const a=e.getBoundingClientRect(),c=document.querySelector("#site-footer");if(!c)return;const u=c.getBoundingClientRect(),x=Math.max(0,a.bottom-(u.top-24));if(x>0){const f=document.body.classList.contains("footer-expanded")?"clamp(8px,1.5vw,16px)":e.classList.contains("typewriter-title--fixed")?"clamp(16px,2.5vw,32px)":"clamp(12px,2vw,24px)";_(e,{bottom:`calc(${f} + ${x}px)`})}}catch(a){y.warn("TypeWriter: checkFooterOverlap failed",a)}},n=()=>{const e=new M({textEl:i,authorEl:r,quotes:l,wait:2400,typeSpeed:85,deleteSpeed:40,shuffle:!0,loop:!0,...p,onBeforeType:u=>{t.classList.add("is-locked");const x=s.getLines(u).join(`
`),f=s.reserveFor(u),d=getComputedStyle(t),m=parseFloat(d.getPropertyValue("--lh-px"))||0,T=parseFloat(d.getPropertyValue("--gap-px"))||0;return _(t,{"--box-h":`${Math.max(0,f*m+(f-1)*T)}px`}),requestAnimationFrame(()=>o(t)),x}});document.addEventListener("hero:typingEnd",()=>{try{t.classList.remove("is-locked")}catch(u){y.warn("TypeWriter: remove lock failed",u)}});const a=()=>{o(t)};a();const c=setInterval(a,100);setTimeout(()=>clearInterval(c),2e3),document.addEventListener("footer:loaded",a,{once:!0}),window.addEventListener("resize",()=>requestAnimationFrame(a),{passive:!0}),g=e};return await(document.fonts?.ready??Promise.resolve()),n(),g}catch(t){return y.error("Init failed",t),!1}}export{M as TypeWriter,q as getTypeWriterInstance,L as initHeroSubtitle,b as stopHeroSubtitle};
