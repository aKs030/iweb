import{initHeroFeatureBundle as R}from"../pages/home/hero-manager.js";import{createLazyLoadObserver as O,createLogger as _,EVENTS as T,fetchWithTimeout as P,fire as A,getElementById as L,schedulePersistentStorageRequest as N,AppLoadManager as w,SectionTracker as H}from"./utils/shared-utilities.js";import{a11y as I}from"./utils/accessibility-manager.js";import"./components/menu/menu.js";const s=_("main");let $=null;const D={isTest:new URLSearchParams(globalThis.location.search).has("test")||navigator.userAgent.includes("HeadlessChrome")||globalThis.location.hostname==="localhost"&&globalThis.navigator.webdriver,debug:new URLSearchParams(globalThis.location.search).has("debug")},v={start:performance.now(),domReady:0,modulesReady:0,windowLoaded:0},x=(()=>{const e=new Map;return(i,{assertive:d=!1,dedupe:u=!1}={})=>{if(i&&!(u&&e.has(i))){u&&(e.set(i,!0),setTimeout(()=>e.delete(i),3e3));try{const n=L(d?"live-region-assertive":"live-region-status");if(!n)return;n.textContent="",requestAnimationFrame(()=>{n.textContent=i})}catch(n){s.debug("Announcement failed:",n)}}}})();globalThis.announce=x;const C=new H;C.init(),D.debug&&(globalThis.sectionTracker=C);const q=(()=>{if(globalThis.SectionLoader)return globalThis.SectionLoader;const e="section[data-section-src]",i=new WeakSet,d=new WeakMap,u=2;function n(t,r,l={}){try{document.dispatchEvent(new CustomEvent(t,{detail:{id:r?.id,section:r,...l}}))}catch(h){s.debug(`Event dispatch failed: ${t}`,h)}}function a(t){const r=t.getAttribute("aria-labelledby");if(r){const l=L(r)?.textContent?.trim();if(l)return l}return t.id||"Abschnitt"}function c(t){return t?.endsWith(".html")?[t.replace(/\.html$/,""),t]:t?.startsWith("/pages/")?[(t||"")+".html",t]:[t,(t||"")+".html"]}async function o(t){let r;const l=c(t);for(const h of l)try{if(r=await P(h),r&&r.ok)break}catch{r=null}if(!r||!r.ok)throw new Error(`HTTP ${r?r.status:"NO_RESPONSE"}: ${r?r.statusText:"no response"}`);return await r.text()}async function f(t){if(i.has(t))return;const r=t.dataset.sectionSrc;if(!r){t.removeAttribute("aria-busy");return}i.add(t);const l=a(t),h=d.get(t)||0;t.setAttribute("aria-busy","true"),t.dataset.state="loading",x(`Lade ${l}\u2026`,{dedupe:!0}),n("section:will-load",t,{url:r});try{const E=await o(r);t.insertAdjacentHTML("beforeend",E);const m=t.querySelector("template");m&&t.appendChild(m.content.cloneNode(!0)),t.querySelectorAll(".section-skeleton").forEach(y=>y.remove()),t.dataset.state="loaded",t.removeAttribute("aria-busy"),x(`${l} geladen`,{dedupe:!0}),n("section:loaded",t,{state:"loaded"}),t.id==="hero"&&A(T.HERO_LOADED)}catch(E){if(s.warn(`Section load failed: ${l}`,E),(/5\d\d/.test(String(E))||!navigator.onLine)&&h<u){d.set(t,h+1),i.delete(t);const m=300*Math.pow(2,h);return await new Promise(y=>setTimeout(y,m)),f(t)}if(t.dataset.state="error",t.removeAttribute("aria-busy"),x(`Fehler beim Laden von ${l}`,{assertive:!0}),n("section:error",t,{state:"error"}),!t.querySelector(".section-retry")){const m=document.createElement("button");m.type="button",m.className="section-retry",m.textContent="Erneut laden",m.addEventListener("click",()=>g(t),{once:!0});const y=document.createElement("div");y.className="section-error-box",y.appendChild(m),t.appendChild(y)}}}async function g(t){t.querySelectorAll(".section-error-box").forEach(r=>r.remove()),t.dataset.state="",i.delete(t),d.delete(t),await f(t)}function S(){if(S._initialized)return;S._initialized=!0;const t=Array.from(document.querySelectorAll(e)),r=[],l=[];if(t.forEach(h=>{h.dataset.eager!==void 0?r.push(h):l.push(h)}),r.forEach(f),l.length){const h=O(f);l.forEach(E=>h.observe(E))}}function p(){S._initialized=!1,S()}const b={init:S,reinit:p,loadSection:f,retrySection:g};return globalThis.SectionLoader=b,b})();function M(){q.init();try{I?.updateAnimations?.(),I?.updateContrast?.()}catch{}}document.readyState!=="loading"?M():document.addEventListener(T.DOM_READY,M,{once:!0});const B=(()=>{let e=null;const i=document.querySelector(".snap-container")||document.documentElement,d=()=>i.classList.add("no-snap"),u=()=>i.classList.remove("no-snap");function n(){d(),clearTimeout(e),e=setTimeout(u,180)}function a(o){["PageDown","PageUp","Home","End","ArrowDown","ArrowUp","Space"].includes(o.key)&&n()}function c(){globalThis.addEventListener("wheel",n,{passive:!0}),globalThis.addEventListener("touchmove",n,{passive:!0}),globalThis.addEventListener("keydown",a,{passive:!0})}return{init:c}})();B.init();const k=(()=>{const e={overlay:null,bar:null,text:null,percent:null,progress:0,interval:null,messageIndex:0,messages:["Initialisiere System...","Assets werden geladen...","Verbinde Neural Interface...","Rendere 3D-Umgebung...","Optimiere Shader...","Starte KI-Module...","Synchronisiere Daten..."]};let i=0,d=!1;function u(){return e.overlay=L("app-loader"),e.bar=L("loader-progress-bar"),e.text=L("loader-status-text"),e.percent=L("loader-percentage"),!!e.overlay}function n(p){e.bar&&(e.bar.style.width=`${Math.floor(e.progress)}%`),e.percent&&(e.percent.textContent=`${Math.floor(e.progress)}%`),p&&e.text&&(e.text.textContent=p)}function a(){e.interval&&(clearInterval(e.interval),e.interval=null)}function c(){e.overlay&&(a(),e.progress=0,e.messageIndex=0,e.overlay.classList.remove("fade-out"),e.overlay.style.display="flex",e.overlay.removeAttribute("aria-hidden"),n(e.messages[e.messageIndex]),e.interval=setInterval(()=>{const p=Math.random()*(e.progress>70?2:5),b=Math.min(e.progress+p,96);e.progress=Math.max(e.progress,b),Math.random()>.8&&e.progress<94?(e.messageIndex=(e.messageIndex+1)%e.messages.length,n(e.messages[e.messageIndex])):n()},120))}function o(p="Bereit."){a(),e.progress=100,n(p)}function f(){if(d||!e.overlay)return;const p=performance.now()-i,b=Math.max(0,600-p);setTimeout(()=>{const t=document.getElementById("threeEarthContainer")||document.getElementById("earth-container"),r=()=>{if(d)return;d=!0,o(),e.overlay.classList.add("fade-out"),e.overlay.setAttribute("aria-hidden","true"),e.overlay.dataset.loaderDone="true";const y=()=>{e.overlay.style.display="none",e.overlay.removeEventListener("transitionend",y)};e.overlay.addEventListener("transitionend",y),setTimeout(y,900);try{document.body.classList.remove("global-loading-visible")}catch{}v.loadingHidden=performance.now(),x("Anwendung geladen",{dedupe:!0}),A(T.LOADING_HIDE),globalThis.dispatchEvent(new Event("app-ready"))};if(!t){r();return}let l=!1;const h=()=>{l||(l=!0,r())},E=setTimeout(()=>{try{console.warn("Earth load timeout - proceeding anyway")}catch{}h()},4e3),m=()=>{clearTimeout(E),h()};window.addEventListener("earth-ready",m,{once:!0}),window.addEventListener("three-first-frame",m,{once:!0}),window.addEventListener("three-ready",m,{once:!0})},b)}function g(){if(i=performance.now(),!!u()){try{document.body.classList.add("global-loading-visible")}catch{}c()}}function S(p,b){!e.overlay||d||(typeof b=="number"&&(e.progress=Math.min(Math.max(b,e.progress),98)),n(p))}return{init:g,hide:f,setStatus:S}})(),W=(()=>{let e=null,i=!1;async function d(){if(!(i||e)){if(D.isTest&&!globalThis.__FORCE_THREE_EARTH){s.info("Test environment detected - skipping Three.js Earth system for performance");return}if(!L("threeEarthContainer")){s.debug("Earth container not found");return}try{if(navigator.connection?.saveData){s.info("Three.js skipped: save-data mode detected");return}}catch(a){s.warn("Three.js guard check failed",a)}i=!0;try{s.info("Loading Three.js Earth system..."),e=await(await import("./components/particles/three-earth-system.js")).default.initThreeEarth(),typeof e=="function"&&($=e,D.debug&&(globalThis.__threeEarthCleanup=e),s.info("Three.js Earth system initialized"),v.threeJsLoaded=performance.now())}catch(a){s.warn("Three.js failed, using CSS fallback:",a)}finally{i=!1}}}function u(){const a=L("threeEarthContainer");if(!a)return;try{const o=a.getBoundingClientRect(),f=o.top<(globalThis.innerHeight||0)+100&&o.bottom>-100,g=document.getElementById("app-loader")?.dataset?.loaderDone!=="true";if(f||g){d();return}}catch{}const c=new IntersectionObserver(o=>{for(const f of o)f.isIntersecting&&(c.disconnect(),d())},{rootMargin:"100px",threshold:.01});c.observe(a)}function n(){globalThis.requestIdleCallback?requestIdleCallback(u,{timeout:2e3}):setTimeout(u,1e3)}return{initDelayed:n}})();document.addEventListener("DOMContentLoaded",async()=>{v.domReady=performance.now(),k.init(),A(T.DOM_READY);let e=!1,i=!1;const d=()=>{!e||!i||w.isBlocked()||(k.setStatus("Starte Experience...",98),k.hide())};document.addEventListener(T.LOADING_UNBLOCKED,d),globalThis.addEventListener("load",()=>{v.windowLoaded=performance.now(),i=!0,k.setStatus("Finalisiere Assets...",92),d()},{once:!0}),A(T.CORE_INITIALIZED),A(T.HERO_INIT_READY),R(),W.initDelayed(),e=!0,v.modulesReady=performance.now(),k.setStatus("Initialisiere 3D-Engine...",90),A(T.MODULES_READY),d(),function n(a=1){const c=(()=>{try{if(w!==void 0&&typeof w.getPending=="function"&&(w.getPending()||[]).includes("three-earth"))return 8e3}catch{}return 5e3})();setTimeout(()=>{if(!i){try{if(w!==void 0&&typeof w.isBlocked=="function"&&w.isBlocked?.()){const o=typeof w.getPending=="function"?w.getPending():[];if(s.warn(`Deferring forced loading screen hide (attempt ${a}): blocking modules=${Array.isArray(o)?o.join(", "):String(o)}`),a<3){n(a+1);return}s.warn("Max attempts reached - forcing hide despite blocking modules")}}catch(o){s.debug("AppLoadManager not available or check failed (expected in some environments)",o)}s.warn("Forcing loading screen hide after timeout"),k.setStatus("Schlie\xDFe Ladebildschirm..."),k.hide()}},a===1?c:5e3)}(),N(2200);const u=()=>{try{document.querySelectorAll('link[rel="stylesheet"][data-defer="1"]').forEach(n=>{try{n.media="all",delete n.dataset.defer}catch{}})}catch{}};try{u(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u,{once:!0}):setTimeout(u,0),globalThis.addEventListener("load",u);const n=new MutationObserver(a=>{for(const c of a)for(const o of c.addedNodes)try{o.nodeType===1&&o.matches?.('link[rel="stylesheet"][data-defer="1"]')&&(o.media="all",delete o.dataset.defer)}catch{}});n.observe(document.head||document.documentElement,{childList:!0,subtree:!0}),globalThis.addEventListener("load",()=>n.disconnect(),{once:!0})}catch{}document.addEventListener("click",n=>{const a=n.target;if(!a)return;if(a?.closest(".retry-btn")){n.preventDefault();try{globalThis.location.reload()}catch{}return}const c=a?.closest(".btn-share");if(c){n.preventDefault();const o=c.dataset.shareUrl||"https://www.youtube.com/@aks.030",f={title:document.title,text:"Schau dir diesen Kanal an",url:o};if(navigator.share)navigator.share(f).catch(g=>s.warn("share failed",g));else if(navigator.clipboard)navigator.clipboard.writeText(o).then(()=>{try{x("Link kopiert",{dedupe:!0})}catch(g){s.warn("announce failed",g)}});else try{globalThis.prompt("Link kopieren",o)}catch(g){s.warn("prompt failed",g)}}}),"serviceWorker"in navigator&&!D.isTest?globalThis.addEventListener("load",async()=>{try{const n=await navigator.serviceWorker.getRegistrations();if(await Promise.all(n.map(a=>a.unregister().catch(c=>s.warn("ServiceWorker unregister failed",c)))),"caches"in window){const a=await caches.keys();await Promise.all(a.map(c=>caches.delete(c)))}s.info("Service Workers unregistered and caches cleared (cleanup).")}catch(n){s.debug("Service Worker cleanup failed:",n)}},{once:!0}):s.info("Service Worker cleanup skipped: not supported or test env"),s.info("Performance:",{domReady:Math.round(v.domReady-v.start),modulesReady:Math.round(v.modulesReady-v.start),windowLoaded:Math.round(v.windowLoaded-v.start)})},{once:!0}),globalThis.addEventListener("pageshow",e=>{e.persisted&&(s.info("Page restored from bfcache"),globalThis.dispatchEvent(new CustomEvent("resize")),!document.hidden&&globalThis.threeEarthSystem&&globalThis.threeEarthSystem.animate&&document.dispatchEvent(new CustomEvent("visibilitychange")))});
